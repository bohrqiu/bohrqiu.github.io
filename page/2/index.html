<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="秋波的程序生活" />










<meta name="description" content="Keep running!">
<meta property="og:type" content="website">
<meta property="og:title" content="qiubo&#39;s life">
<meta property="og:url" content="http://bohr.me/page/2/index.html">
<meta property="og:site_name" content="qiubo&#39;s life">
<meta property="og:description" content="Keep running!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="qiubo&#39;s life">
<meta name="twitter:description" content="Keep running!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://bohr.me/page/2/"/>





  <title>qiubo's life</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e81935b4d5ec7e3e782fe240cbd9c21c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">qiubo's life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay Hungry, Stay Foolish</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/一次技术问答/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/一次技术问答/" itemprop="url">一次技术问答</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-28T21:52:17+08:00">
                2017-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>最近一年多都没有写博客了，技术上做了很多有意义的事情，也有一些经验上的积累，逐步沉淀到博客上。</p>
<p>今天回答某公司的技术上的一些疑问，把问题和回答贴上来。逐步<code>养</code>自己的技术观。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/一次技术问答/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2016-08-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016-08-reading-notes/" itemprop="url">2016年08月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-10T21:52:17+08:00">
                2016-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>服务发现用于动态感知服务提供方地址，并提供服务路由分发策略能力。</p>
<h3 id="1-客户端发现"><a href="#1-客户端发现" class="headerlink" title="1. 客户端发现"></a>1. 客户端发现</h3><p>客户端从注册中心获取服务列表，客户端监听服务列表的变化，客户端通过路由策略选择合适的服务端地址。</p>
<p>服务端在停服务时，需要先通知客户端不要发送新请求过来，等服务端把当前请求处理完后，才断开连接。</p>
<h3 id="2-代理端发现"><a href="#2-代理端发现" class="headerlink" title="2. 代理端发现"></a>2. 代理端发现</h3><p>代理端对外提供服务，主要用于对外请求路由。代理端(比如nginx/haproxy)转发请求到后端服务。后端服务暴露地址到注册中心，代理程序动态获取服务地址。</p>
<p>nginx可以试试<a href="https://github.com/weibocom/nginx-upsync-module" target="_blank" rel="noopener">nginx-upsync-module</a></p>
<p>在k8s内部，采用nginx+dns+k8s proxy实现。</p>
<h2 id="关于高可用系统"><a href="#关于高可用系统" class="headerlink" title="关于高可用系统"></a>关于高可用系统</h2><p><a href="http://coolshell.cn/articles/17459.html" target="_blank" rel="noopener">http://coolshell.cn/articles/17459.html</a></p>
<p>前段时间写了一段公司的公关文(CUI NIU BI)，强迫自己写了<code>5个9</code>。</p>
<p>作者讲了几个大实话：</p>
<blockquote>
<blockquote>
<p>如果你没有一套科学的牛逼的软件工程的管理，没有牛逼先进的自动化的运维工具，没有技术能力很牛逼的工程师团队，怎么可能出现高可用的系统啊。</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>深层次的东西则是——对工程这门科学的尊重：1.对待技术的态度 2.一个公司的工程文化 3.领导者对工程的尊重</p>
</blockquote>
</blockquote>
<p>佛渡有缘人，点到即止，不强求。</p>
<ol>
<li>以前对高可用的关注点主要在应用层面，现在加入运维团队后，高可用的关注点延伸到机房、硬件。</li>
<li>同城双活只要网络质量靠谱点，还是比较好做，主要是南北请求路由控制和东西流量故障切换。</li>
<li>把服务不可用的因素分成<a href="https://docs.oracle.com/cd/A91202_01/901_doc/rac.901/a89867/pshavdtl.htm" target="_blank" rel="noopener">planned、unplanned</a>，分别设计预案</li>
</ol>
<p>也许把<code>SLA</code>写到合同里，我就不敢乱吹牛逼了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2016-06-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016-06-reading-notes/" itemprop="url">2016年06月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-19T21:52:17+08:00">
                2016-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Service-Wiring-with-Spring-Cloud"><a href="#Service-Wiring-with-Spring-Cloud" class="headerlink" title="Service Wiring with Spring Cloud"></a>Service Wiring with Spring Cloud</h2><p><a href="https://www.infoq.com/articles/spring-cloud-service-wiring" target="_blank" rel="noopener">https://www.infoq.com/articles/spring-cloud-service-wiring</a></p>
<p>这篇文章聊到了spring cloud如何提供配置管理、服务发现、服务路由能力。结合我们的现状谈谈：</p>
<ol>
<li>有些应用没有做到cloud-ready，依赖服务地址配置信息写死。。</li>
<li>内部请求用dubbo，实现了服务发现，服务路由，大多数问题已经hold住了</li>
<li>自研的配置管理系统可以做到配置动态更新，比spring cloud 下的<code>Enabling Dynamic Refresh</code>做法优雅多不少</li>
<li>还需要提供http服务的服务注册、发现能力。为外部http负载均衡、内部http服务依赖提供服务发现、服务路由能力</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2016-05-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016-05-reading-notes/" itemprop="url">2016年05月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-11T21:52:17+08:00">
                2016-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="NGINX-Plus-vs-F5-BIG-IP-A-Price-Performance-Comparison"><a href="#NGINX-Plus-vs-F5-BIG-IP-A-Price-Performance-Comparison" class="headerlink" title="NGINX Plus vs. F5 BIG-IP: A Price-Performance Comparison"></a>NGINX Plus vs. F5 BIG-IP: A Price-Performance Comparison</h2><p>当通用硬件的处理能力越来越强，专有芯片的使用场景会越来越少，硬件提供商会逐步转型为软件提供商。以前也听到不少声音，比如某硬件负载设备，通用cpu中集成了<code>LVS</code>.</p>
<p>未来我们可能、会、应该废弃掉大部分负载均衡设备吧。</p>
<h2 id="Microservices-Oracle-A-Bright-Future"><a href="#Microservices-Oracle-A-Bright-Future" class="headerlink" title="Microservices + Oracle: A Bright Future"></a>Microservices + Oracle: A Bright Future</h2><p>这篇文章对微服务的讲述很全面。部分观点不谋而合…</p>
<p><iframe src="//www.slideshare.net/slideshow/embed_code/key/y5r6fWXDjIHS9I" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/KellyGoetsch/microservices-oracle-a-bright-future" title="Microservices + Oracle: A Bright Future" target="_blank">Microservices + Oracle: A Bright Future</a> </strong> from <strong><a href="//www.slideshare.net/KellyGoetsch" target="_blank">Kelly Goetsch</a></strong> </div></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2016-04-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016-04-reading-notes/" itemprop="url">2016年04月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-05T21:52:17+08:00">
                2016-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Contended-FOR-false-sharing"><a href="#Contended-FOR-false-sharing" class="headerlink" title="@Contended FOR false sharing"></a><a name="false-sharing">@Contended FOR false sharing</a></h2><p>ABOUT False Sharing：</p>
<blockquote>
<blockquote>
<p>Most high performance processors, insert a cache buffer between slow memory and the high speed registers of the CPU. Accessing a memory location causes a slice of actual memory (a cache line) containing the memory location requested to be copied into the cache. Subsequent references to the same memory location or those around it can probably be satisfied out of the cache until the system determines it is necessary to maintain the coherency between cache and memory.</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>Each update of an individual element of a cache line marks the line as invalid. Other processors accessing a different element in the same line see the line marked as invalid. They are forced to fetch a more recent copy of the line from memory or elsewhere, even though the element accessed has not been modified. This is because cache coherency is maintained on a cache-line basis, and not for individual elements. As a result there will be an increase in interconnect traffic and overhead.</p>
</blockquote>
</blockquote>
<p>当下列条件满足时，False sharing极大降低了并发性能。</p>
<ul>
<li>Shared data is modified by multiple processors.</li>
<li>Multiple processors update data within the same cache line.</li>
<li>This updating occurs very frequently (for example, in a tight loop).</li>
</ul>
<p>java8 引入了<code>@Contended</code>，在对象编译时，编译器会插入<code>padding</code>,防止多个数据在一个cache line中。</p>
<p><code>https://github.com/m0wfo/false-sharing-demo</code>测试结果：</p>
<pre><code>[0] % java -XX:-RestrictContended -jar target/false-sharing-demo-1.0.0-SNAPSHOT.jar plain
Updating unpadded version 1B times Took: 55.457223514sec
Updating @Contended version 1B times Took: 7.387646696sec
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2016-02-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016-02-reading-notes/" itemprop="url">2016年02月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-02-01T21:52:17+08:00">
                2016-02-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="每个架构师都应该研究下康威定律"><a href="#每个架构师都应该研究下康威定律" class="headerlink" title="每个架构师都应该研究下康威定律"></a><a name="about-arch"><a href="http://mp.weixin.qq.com/s?__biz=MzA5Nzc4OTA1Mw==&amp;mid=408286995&amp;idx=1&amp;sn=1634698023c48b754d42af69cee2ab32" target="_blank" rel="noopener">每个架构师都应该研究下康威定律</a></a></h2><p>最近在做<code>DEVOPS</code>,看技术的出发点有所变化，正好看到这篇文章，总结下自己。</p>
<h3 id="1-系统架构的目标是解决利益相关者的关注点。"><a href="#1-系统架构的目标是解决利益相关者的关注点。" class="headerlink" title="1. 系统架构的目标是解决利益相关者的关注点。"></a>1. 系统架构的目标是解决利益相关者的关注点。</h3><blockquote>
<blockquote>
<p>架构其实是发现利益相关者（stakeholder），然后解决他们的关注点（concerns）</p>
<p>业务方，产品经理，客户/用户，开发经理，工程师，项目经理，测试人员，运维人员，产品运营人员等等都有可能是利益相关者，架构师要充分和利益相关者沟通，深入理解他们的关注点和痛点，并出架构解决这些关注点。</p>
</blockquote>
</blockquote>
<p>架构师在这里也定位为一个好的需求分析师，但是架构师往往会从自己的角度(利益相关或者立场相关)来设计。我之前一直做开发工作，在技术选型或者研究时，对于可运维性考虑得比较少，在痛过几次后，发现监控的价值，来补充相关<code>metrics</code>的能力。</p>
<h3 id="2-关注非功能性需求"><a href="#2-关注非功能性需求" class="headerlink" title="2. 关注非功能性需求"></a>2. 关注非功能性需求</h3><ul>
<li>easy to separate</li>
<li>easy to understand</li>
<li>easy to extend</li>
<li>easy to change</li>
<li>easy to replace</li>
<li>easy to deploy</li>
<li>easy to scale</li>
<li>easy to recover</li>
<li>easy to connect</li>
<li>easy to afford</li>
</ul>
<blockquote>
<blockquote>
<p>Architecture represents the significant design decisions that shape a system, where significant is measured by cost of change.</p>
<p>架构的目标是用于管理复杂性、易变性和不确定性，以确保在长期的系统演化过程中，一部分架构的变化不会对架构的其它部分产生不必要的负面影响。</p>
</blockquote>
</blockquote>
<p>这里补充一点，需要考虑<code>easy to find the problem</code>。除了合理的规划日志，我们要做到<code>failfast</code>。当关键资源依赖条件不满足，我们最好是把问题用最显示的方式暴露出来，而不是让它在那里一直报错。</p>
<h3 id="3-架构的迭代和演化性"><a href="#3-架构的迭代和演化性" class="headerlink" title="3. 架构的迭代和演化性"></a>3. 架构的迭代和演化性</h3><blockquote>
<blockquote>
<p>做技术架构的都有点完美主义倾向，一开始往往喜欢求大求全，忽视架构的演化和迭代性，这种倾向易造产品和用户之间不能形成有效快速的反馈，产品不满足最终用户需求.</p>
<p>在系统真正地投入生产使用之前，再好的架构都只是假设，产品越晚被使用者使用，失败的成本和风险就越高，而小步行进，通过MVP快速实验，获取客户反馈，迭代演化产品，能有效地减少失败的成本和风险。</p>
</blockquote>
</blockquote>
<p>好的架构是衍变出来的，而非设计出来的。</p>
<h3 id="4-构建闭环反馈架构"><a href="#4-构建闭环反馈架构" class="headerlink" title="4. 构建闭环反馈架构"></a>4. 构建闭环反馈架构</h3><blockquote>
<blockquote>
<p>第一条道路，系统思维，开发驱动的组织机体，其能力不是制作软件，而是持续的交付客户价值，架构师需要有全局视角和系统思维（System Thinking），深入理解整个价值交付链，从业务需求、研发、测试、集成，到部署运维，这条价值链的效率并不依赖于单个或者几个环节，局部优化的结果往往是全局受损，架构师要站在系统高度去优化整个价值交付链，让企业和客户之间形成快速和高效的价值传递。</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>第二条道路，强化反馈环，任何过程改进的目标都是加强和缩短反馈环。</p>
<p>收集-&gt;测量-&gt;调整-&gt;闭环重复，在有测量数据和反馈的基础上，系统、应用、流程和客户体验才有可能获得持续的提升和改善，否则没有数据的所谓改进只能靠拍脑袋或者说猜测。</p>
</blockquote>
</blockquote>
<p>这里提到监控的重要性，<strong>没有测量，就没有改进和提升</strong>，<a href="http://www.infoq.com/cn/articles/metrics-driven-development" target="_blank" rel="noopener">MDD</a>这偏文章有点意思，通过分层和可用的性能指标让开发人员了解项目业务方面的内容，反过来，业务人员也能理解项目技术方面的内容，看到开发人员所面临的问题和我们的负载局限。</p>
<blockquote>
<blockquote>
<p>第三条道路，鼓励勇于承担责任，冒险试错和持续提升的文化。</p>
</blockquote>
</blockquote>
<p>最后，贴上一张关于<code>DevOps</code>的图。</p>
<p><img src="/2016-02-reading-notes/devops.jpg" alt=""></p>
<h2 id="时间序列数据库的秘密"><a href="#时间序列数据库的秘密" class="headerlink" title="时间序列数据库的秘密"></a>时间序列数据库的秘密</h2><p><a href="http://www.infoq.com/cn/articles/database-timestamp-01" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/database-timestamp-01</a></p>
<p><a href="http://www.infoq.com/cn/articles/database-timestamp-01" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/database-timestamp-01</a></p>
<p><a href="http://www.infoq.com/cn/articles/database-timestamp-01" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/database-timestamp-01</a></p>
<p>此文讲明白了时序数据库，最近也在纠结这个事(原来一直看好opentsdb，但是没有深入调研opentsdb的细节，对es也不是太了解)，这里总结下全文。</p>
<p>时间序列数据库除了提供查询能力外，我们也希望能够提供在查询阶段做聚合能力。</p>
<p>聚合有有三个步骤:</p>
<ul>
<li>用索引检索出行号(搜索引擎最擅长)</li>
<li>从主存储按行号加载列(列式存储最合适)</li>
<li>计算(分布式计算列数据)</li>
</ul>
<p><code>ES</code>在这三个步骤上都做得很好。</p>
<ol>
<li><p>如何快速检索？</p>
<p> <img src="http://cdn3.infoqstatic.com/statics_s2_20160217-0123u3/resource/articles/database-timestamp-02/zh/resources/0820002.jpg" alt=""></p>
<p> lucene倒排索引由<code>Term index</code>-&gt;<code>Term Dictionary</code>-&gt;<code>Posting List</code>构成。<code>TI</code>是对<code>TD</code>做的索引，实现对Term的快速查找。Mysql使用b-tree排序存储<code>TD</code>在磁盘上;<code>Lucene</code>增加了<code>TI</code>保存在内存中，查询效率更高。</p>
</li>
<li><p>如何联合索引查询？</p>
<p> 对于<code>age=18 AND gender=女</code>的查询过滤。mysql的做法是(如果两个列都建立了索引，当然gender列做索引在mysql上没有什么卵用)先在索引上找<code>age=18</code>的所有id，然后遍历id匹配。</p>
<p> Elasticsearch支持：</p>
<ul>
<li><p>使用skip list数据结构。同时遍历gender和age的posting list，互相skip；</p>
<p>  利用skip list(Level0存储原始有序数据，level1存储部分数据，查找时从level1跳过部分数据)，跳过了遍历的成本,并且用<code>Frame of Reference</code>(计算差值，分块后，每个块内部选择合适的bit来存储)压缩存储。</p>
</li>
<li><p>使用bitset数据结构，对gender和age两个filter分别求出bitset，对两个bitset做AN操作。</p>
<p>  大多数场景下，bitset非常稀疏，bitset压缩空间很大。lucene采用<code>Roaring Bitmap</code>,算法也有点意思：<br>  计算N/65536和N%65536的值，把N/65536相同的分为一个组，分组后根据每个组的情况用short数字或者bitset。</p>
</li>
</ul>
</li>
<li><p>如何减少文档数？</p>
<p> 一般采用数据库会合并，把多行数据合并成一行，比如把原来精确到秒的数据合并为分。<code>ES</code>中使用内嵌文档(Nested Document)实现公共字段的去从(比如应用名、ip、环境标识、metricsname)</p>
</li>
<li><p>如何加载更快？</p>
<p> 如何利用索引和主存储，是一种两难的选择。</p>
<ul>
<li><p>选择不使用索引，只使用主存储：除非查询的字段就是主存储的排序字段，否则就需要顺序扫描整个主存储。</p>
<p>   这要求数据存储按照查询条件来选择主键(mysql中的聚簇索引)，如果查询条件很多，会扫描整个文件。</p>
</li>
<li><p>选择使用索引，然后用找到的row id去主存储加载数据：这样会导致很多碎片化的随机读操作。</p>
<p>  从硬盘上随机读写性能低</p>
</li>
</ul>
<p>Lucene底层读取文件基于mmap，充分利用操作系统的特性来映射文件到内存(列式存储的优点是每列一个文件，可以充分利用mmap，加载需要的列)，所以还是内存越大越好。</p>
</li>
<li><p>分布式聚合如何做得快？</p>
<p> 通过数据分片，把数据分散到多台机器。在计算时，各个节点index计算聚合结果，然后汇总后在聚合。这样也减少了网络带宽，充分利用了各个节点的计算能力。</p>
</li>
<li><p>为什么时间序列需要更复杂的聚合？</p>
<p> 通常会有降频(比如原来时间精确到秒，现在需要以分为单位)和降维(比如原来有地域纬度，统计时求所有地区)需求。<code>ES</code>支持Pipeline Aggregation可以实现数据在聚合之后再做聚合，能满足多次聚合的需求。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/docker/" itemprop="url">docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-01T21:52:17+08:00">
                2016-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-docker配置"><a href="#1-docker配置" class="headerlink" title="1. docker配置"></a>1. docker配置</h3><p>在mac osx中，docker deamon运行在virtualbox虚拟机中，docker client和虚拟机中的docker deamon交互。</p>
<h4 id="1-1-环境配置"><a href="#1-1-环境配置" class="headerlink" title="1.1 环境配置"></a>1.1 环境配置</h4><pre><code>#配置docker环境变量
eval &quot;$(docker-machine env default)&quot;
#配置docker启动alias    
alias docker-start=&apos;docker-machine start default&apos;
#配置docker关闭alias
alias docker-stop=&quot;docker-machine stop default&quot;
</code></pre><p>启动命令如下：</p>
<pre><code>docker-start
docker-stop
</code></pre><h4 id="1-2-配置镜像私服"><a href="#1-2-配置镜像私服" class="headerlink" title="1.2 配置镜像私服"></a>1.2 配置镜像私服</h4><p>测试环境中私服提供服务如下：</p>
<pre><code>#docker registry ui
http://192.168.46.21:10005/
#docker registry restful api
http://192.168.46.21:5000/v2/_catalog
</code></pre><p>下面配置docker registry私服为192.168.46.21：</p>
<pre><code>#登陆到server
docker-machine ssh default

#修改/var/lib/boot2docker/profile
--insecure-registry 192.168.46.21:5000
--registry-mirror http://192.168.46.21:5000
</code></pre><p>国内docker mirror：</p>
<pre><code>https://lug.ustc.edu.cn/wiki/mirrors/help/docker
http://0b929cdf.m.daocloud.io
</code></pre><h3 id="2-docker-常用命令"><a href="#2-docker-常用命令" class="headerlink" title="2. docker 常用命令"></a>2. docker 常用命令</h3><p><img src="/docker/docker-command.jpg" alt=""></p>
<pre><code>#拉取镜像
docker pull yiji/java8:1.0

#查看镜像历史,能看到docker镜像层的细节
docker history  yiji/java8:1.0

#删除镜像
docker rmi -f yiji/centos7:latest

#删除容器
docker rm

#执行命令    
docker run yiji/centos7 /bin/echo &apos;hello world&apos;

#交互运行：
docker run -it yiji/centos7 /bin/bash

#查看容器运行状态
docker ps -a

#查看指定容器状态
docker inspect f46935242662

#查看端口隐射，通过inspect结果过滤
docker inspect --format=&apos;{{.NetworkSettings.Ports}}&apos; 8f4a179a0647

#查看容器资源占用
docker stats 92202cc1c3f0

#查看docker deamon运行ip
echo $DOCKER_HOST

#清理后台停止的容器
docker rm $( docker ps -a -q)

#查看镜像的环境变量
docker run  yiji/java8:2.0  env
</code></pre><h3 id="3-F-A-Q"><a href="#3-F-A-Q" class="headerlink" title="3. F.A.Q"></a>3. F.A.Q</h3><h4 id="3-1-docker文件系统"><a href="#3-1-docker文件系统" class="headerlink" title="3.1. docker文件系统"></a>3.1. docker文件系统</h4><p>docker镜像的文件系统采用多层存储，镜像中全是只读层，便于分发和共享(pull镜像时，会在本地拉已经存在的层)。运行时建立读写层，对于应用来说，需要把文件系统mount到docker中(这样性能最好)，device mapper对性能有影响。</p>
<blockquote>
<blockquote>
<p>Data volumes provide the best and most predictable performance. This is because they bypass the storage driver and do not incur any of the potential overheads introduced by thin provisioning and copy-on-write. For this reason, you may want to place heavy write workloads on data volumes.</p>
</blockquote>
</blockquote>
<h4 id="3-2-关于基础镜像"><a href="#3-2-关于基础镜像" class="headerlink" title="3.2. 关于基础镜像"></a>3.2. 关于基础镜像</h4><p>制作基础镜像时权衡镜像大小(虽然可以在主机上缓存基础镜像，也需要考虑首次分发的大小)。我们最开始使用centos7来制作基础镜像，发现镜像300多M，如果在加上java8，基础镜像有600多M了。</p>
<p>可以参考<a href="https://hub.docker.com/r/frolvlad/alpine-oraclejdk8/" target="_blank" rel="noopener">frolvlad/alpine-oraclejdk8</a>来制作基础镜像。</p>
<pre><code>REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
yiji/java8          2.0                 1d58b31d19a0        4 days ago          166.5 MB
</code></pre><p>java8的基础镜像只有不到200m。</p>
<h4 id="3-3-制作docker镜像并运行"><a href="#3-3-制作docker镜像并运行" class="headerlink" title="3.3. 制作docker镜像并运行"></a>3.3. 制作docker镜像并运行</h4><ol>
<li><p>编写Dockerfile</p>
<pre><code>FROM yiji/java8:2.0
COPY  yiji-boot-test-1.1-SNAPSHOT.jar /opt/yiji-boot-test-1.1-SNAPSHOT.jar
WORKDIR /opt
ENTRYPOINT java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=4004 -jar /opt/yiji-boot-test-1.1-SNAPSHOT.jar
</code></pre></li>
<li><p>build   </p>
<pre><code>docker build -t  yiji-boot-test:1.0 .
</code></pre></li>
<li><p>run</p>
<pre><code>docker run -p 8081:8081 -p 4004:4004  yiji-boot-test:1.0
</code></pre><p> 其中8081是应用web端口，4004端口是远程调试端口</p>
</li>
<li><p>在容器内执行命令</p>
<p> 在容器运行起来后，我们需要去容器内check下情况。</p>
<pre><code>docker exec -it 92202cc1c3f0  sh
</code></pre></li>
</ol>
<h4 id="3-4-docker本地存储"><a href="#3-4-docker本地存储" class="headerlink" title="3.4 docker本地存储"></a>3.4 docker本地存储</h4><p>docker 容器运行的文件存储在本地。下面来看看这些文件：</p>
<p>查看docker container id</p>
<pre><code>CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS                   PORTS                                            NAMES
8f4a179a0647        yiji-boot-test:1.0   &quot;/bin/sh -c &apos;java -ag&quot;   2 hours ago         Up 2 hours               0.0.0.0:4004-&gt;4004/tcp, 0.0.0.0:8081-&gt;8081/tcp   silly_northcutt
</code></pre><p>登陆到虚拟机，在mac和windows下，docker在虚拟机中运行</p>
<pre><code>docker-machine ssh default
</code></pre><p>切换到docker运行目录</p>
<pre><code>sudo su -
cd /var/lib/docker/aufs/mnt/
</code></pre><p><code>ls |grep 8f4a179a0647</code>发现两个目录</p>
<pre><code>8f4a179a064737658b4055fb785c432c843f473a9d5fc40fba445017bd5b7e2e
8f4a179a064737658b4055fb785c432c843f473a9d5fc40fba445017bd5b7e2e-init
</code></pre><p>进入到第一个目录的opt子目录下，会找到我们打包的jar文件(chroot的魔力所在)</p>
<pre><code>root@default:/mnt/sda1/var/lib/docker/aufs/mnt/8f4a179a064737658b4055fb785c432c843f473a9d5fc40fba445017bd5b7e2e/opt# ls -l
total 67168
-rw-r--r--    1 root     root      68777433 Dec 28 08:26 yiji-boot-test-1.1-SNAPSHOT.jar
</code></pre><h4 id="3-5-关于docker的安全"><a href="#3-5-关于docker的安全" class="headerlink" title="3.5 关于docker的安全"></a>3.5 <a name="docker-security">关于docker的安全</a></h4><p><iframe src="//www.slideshare.net/slideshow/embed_code/key/vhMhelcV6Z9rXr" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/jpetazzo/docker-linux-containers-lxc-and-security" title="Docker, Linux Containers (LXC), and security" target="_blank">Docker, Linux Containers (LXC), and security</a> </strong> from <strong><a href="//www.slideshare.net/jpetazzo" target="_blank">Jérôme Petazzoni</a></strong> </div></p>
<p>我们需要做两件事情，</p>
<ol>
<li><p>不要使用root in docker</p>
<p> 参考<a href="http://stackoverflow.com/questions/24308760/running-app-inside-docker-as-non-root-user" target="_blank" rel="noopener">Running app inside Docker as non-root user</a></p>
</li>
<li><p>经常升级内核</p>
</li>
</ol>
<p>做安全的同学可以看看更多关于docker 安全的文章:</p>
<p><a href="https://github.com/docker/docker-bench-security" target="_blank" rel="noopener">docker-bench-security</a></p>
<p><a href="https://github.com/konstruktoid/Docker/blob/master/Security/CheatSheet.md" target="_blank" rel="noopener">Security CheatSheet</a></p>
<p><a href="https://benchmarks.cisecurity.org/tools2/docker/CIS_Docker_1.6_Benchmark_v1.0.0.pdf" target="_blank" rel="noopener">CIS Docker 1.6 Benchmark</a></p>
<p>最后引用<a href="https://twitter.com/mortman" target="_blank" rel="noopener">David Mortman</a>在2015年<a href="https://www.defcon.org/" target="_blank" rel="noopener">Defcon</a>的一句话：</p>
<blockquote>
<blockquote>
<p>a year ago, [docker and security] was pretty horrible,six months ago it wasn’t so bad, and now it’s pretty usable.</p>
</blockquote>
</blockquote>
<h4 id="3-6-docker-run-vm"><a href="#3-6-docker-run-vm" class="headerlink" title="3.6 docker run vm?"></a>3.6 docker run vm?</h4><p>一些观点：</p>
<p><a href="http://dockone.io/article/935" target="_blank" rel="noopener">2016年六大OpenStack &amp; Docker发展趋势预测</a></p>
<blockquote>
<blockquote>
<p>由原本的虚拟机管理程序为核心转变为容器加裸机组合模式</p>
</blockquote>
</blockquote>
<p><a href="http://www.infoq.com/cn/news/2015/12/hypernetes-caas" target="_blank" rel="noopener">Hypernetes实现多租户CaaS，且无需客户操作系统</a></p>
<blockquote>
<blockquote>
<p>OpenStack是一个用于构建和管理云的IaaS框架，Hypernetes使用了它的部分组件。它使用OpenStack的身份和服务目录提供程序Keystone进行身份验证和授权。它还使用了其他的OpenStack组件，如用于存储的Cinder和Ceph，用于网络管理的Neutron。对于OpenStack而言，这是一个独特的用法，因为其组件通常都不在OpenStack部署之外使用。</p>
</blockquote>
</blockquote>
<h4 id="3-7-docker-api"><a href="#3-7-docker-api" class="headerlink" title="3.7 docker api"></a>3.7 docker api</h4><h5 id="3-7-1-unix-socket-api"><a href="#3-7-1-unix-socket-api" class="headerlink" title="3.7.1 unix-socket api"></a>3.7.1 unix-socket api</h5><p>查看docker信息:</p>
<pre><code>curl --unix-socket /var/run/docker.sock http:/info |jq
</code></pre><p>api文档:</p>
<pre><code>https://docs.docker.com/engine/reference/api/docker_remote_api/
</code></pre><h5 id="3-7-2-java-api"><a href="#3-7-2-java-api" class="headerlink" title="3.7.2 java api"></a>3.7.2 java api</h5><p>依赖：</p>
<pre><code>&lt;dependency&gt;
        &lt;groupId&gt;com.github.docker-java&lt;/groupId&gt;
        &lt;artifactId&gt;docker-java&lt;/artifactId&gt;
        &lt;version&gt;3.0.1&lt;/version&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;de.gesellix&lt;/groupId&gt;
                &lt;artifactId&gt;unix-socket-factory&lt;/artifactId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kohlschutter.junixsocket&lt;/groupId&gt;
        &lt;artifactId&gt;junixsocket-common&lt;/artifactId&gt;
        &lt;version&gt;2.0.4&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.kohlschutter.junixsocket&lt;/groupId&gt;
        &lt;artifactId&gt;junixsocket-native-common&lt;/artifactId&gt;
        &lt;version&gt;2.0.4&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre><p> 使用：</p>
<pre><code> DockerClient dockerClient = DockerClientBuilder.getInstance(&quot;unix:///var/run/docker.sock&quot;).build();
Info info = dockerClient.infoCmd().exec();
System.out.print(info);
</code></pre><p>api文档:</p>
<pre><code>https://github.com/docker-java/docker-java/
</code></pre><h4 id="3-8-docker-on-centos7配置"><a href="#3-8-docker-on-centos7配置" class="headerlink" title="3.8 docker on centos7配置"></a>3.8 docker on centos7配置</h4><p>centos7使用systemd来管理服务，docker配置文件<code>/lib/systemd/system/docker.service</code>。比如增加tcp api端口，修改</p>
<pre><code>ExecStart=/usr/bin/dockerd
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --insecure-registry catalog.shurenyun.com
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/why-react/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/why-react/" itemprop="url">Why react?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-12-01T21:52:17+08:00">
                2015-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天给朋友推荐了<code>React</code>，但心里还真没有底，这里整理下资料，如果不考虑浏览器兼容性的问题，这东东真不错😄。</p>
<h4 id="1-虚拟dom是什么？"><a href="#1-虚拟dom是什么？" class="headerlink" title="1. 虚拟dom是什么？"></a>1. 虚拟dom是什么？</h4><p>虚拟DOM是HTML DOM的抽象，它和浏览器的实现分离。</p>
<h4 id="2-为什么虚拟dom快？"><a href="#2-为什么虚拟dom快？" class="headerlink" title="2. 为什么虚拟dom快？"></a>2. 为什么虚拟dom快？</h4><p>DOM拖慢JavaScript。所有的DOM操作都是同步的，会堵塞浏览器。JavaScript操作DOM时，必须等前一个操作结束，才能执行后一个操作。只要一个操作有卡顿，整个网页就会短暂失去响应。浏览器重绘网页的频率是60FPS（即16毫秒/帧），JavaScript做不到在16毫秒内完成DOM操作，因此产生了跳帧。虚拟dom的改变并不会引起浏览器dom的改变，而是由React在合适的时机比较差异并渲染，保证<code>FPS</code>。</p>
<h4 id="3-Why-is-React’s-concept-of-Virtual-DOM-said-to-be-more-performant-than-dirty-model-checking"><a href="#3-Why-is-React’s-concept-of-Virtual-DOM-said-to-be-more-performant-than-dirty-model-checking" class="headerlink" title="3. Why is React’s concept of Virtual DOM said to be more performant than dirty model checking?"></a>3. Why is React’s concept of Virtual DOM said to be more performant than dirty model checking?</h4><p>React knows when to re-render the scene because it is able to <strong>observe when this data changes</strong>. Dirty checking is slower than observables because you must poll the data at a regular interval and check all of the values in the data structure recursively. By comparison, setting a value on the state will signal to a listener that some state has changed, so React can simply listen for change events on the state and queue up re-rendering.(这点随着es6的<code>Proxy</code>到来，<code>AngularJS</code>会越来越强大😄)</p>
<h4 id="4-What-makes-React-fast"><a href="#4-What-makes-React-fast" class="headerlink" title="4. What makes React fast ?"></a>4. What makes React fast ?</h4><ul>
<li>Batched DOM read/write operations.</li>
<li>Efficient update of sub-tree only.</li>
</ul>
<p>Compared to dirty-check, the key differences IMO are:</p>
<p>Model dirty-checking: React component is explicitly set as dirty whenever setState is called, so there’s no comparison (of the data) needed here. For dirty-checking, the comparison (of the models) always happen each digest loop.</p>
<p>DOM updating: DOM operations are very expensive because modifying the DOM will also apply and calculate CSS styles, layouts. The saved time from unnecessary DOM modification can be longer than the time spent diffing the virtual DOM.</p>
<h4 id="4-What’s-the-problem-of-template-engine？"><a href="#4-What’s-the-problem-of-template-engine？" class="headerlink" title="4. What’s the problem of template engine？"></a>4. What’s the problem of template engine？</h4><p>Template languages express the initial render of your application, and you’re responsible for manually mutating the state of the UI when your backing data changes and events occur.</p>
<h4 id="5-how-to-run"><a href="#5-how-to-run" class="headerlink" title="5. how to run ?"></a>5. how to run ?</h4><p><img src="/why-react/reactjs.png" alt=""></p>
<p>上面部分是用户触发的，下面部分是定时触发的。</p>
<p>首先说上面部分：</p>
<ol>
<li>用户点击某dom</li>
<li><p><code>top-level event handler</code>分发事件到指定的<code>event handler</code></p>
<p> <code>top-level event handler</code>指的是<code>document</code>上的<code>event handler</code>,这种方式能够提高性能(因为在每个真实的dom上面绑定事件是非常慢的)并且跨浏览器(浏览器中的事件本身就没有统一)</p>
</li>
<li><p>用户代码调用setState()</p>
<p> <code>AngularJS</code>双向绑定，不需要用户调用状态变更。所以，必须要去做大量的<code>dirty check</code>。虽然是一种倒退，但是为了性能忍了，等ES6吧。</p>
</li>
</ol>
<p>下面部分的逻辑：<code>event loop</code>周期性的检查有状态组件是否<code>dirty</code>，然后通过<code>diff</code>算法批量更新浏览器dom树。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/be-happy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/be-happy/" itemprop="url">don't worry, be happy!</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-22T21:52:17+08:00">
                2015-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="情绪地雷区避雷方案："><a href="#情绪地雷区避雷方案：" class="headerlink" title="情绪地雷区避雷方案："></a>情绪地雷区避雷方案：</h3><ol>
<li>安排B计划 (比如等人吃饭，提前准备点事做，别人没到就做自己的事)</li>
<li>公开自己的情绪死穴 (比如提前给人说哪些是不喜欢的，如果你这样做了，我也避免不了我不发脾气)</li>
</ol>
<h3 id="情绪管理在生活与工作中的应用"><a href="#情绪管理在生活与工作中的应用" class="headerlink" title="情绪管理在生活与工作中的应用"></a>情绪管理在生活与工作中的应用</h3><ol>
<li><p>正向思考</p>
<p> 凡事往正面的角度去想，选取对自己最有利的注解</p>
</li>
<li><p>转移注意力</p>
<p> 去做能带来好情绪的活动或事情。比如吃自己最喜爱的食物</p>
</li>
<li><p>让开放的肢体动作带动情绪</p>
<p> 比如去爬山，去跑步，去旅游。</p>
</li>
<li><p>透过问句引导自己改变认知</p>
<pre><code>a.对方是故意的还是无心的？
b.这件事还有没有其他角度与意义可以让我感觉更好？
c.如果我希望自己的情绪变好，现在我应该做什么？
d.这样做是真的会让情绪变好还是会有后遗症？
e.我可以寻求谁的帮助来改善自己的情绪？
</code></pre></li>
</ol>
<ol>
<li>发现自己情绪有失控的感觉或倾向，必要时离开现场</li>
<li>把不满、愤怒、失意等负面情绪写在纸上，然后烧掉、冲掉、寄出或者收藏</li>
<li>了解自身的有点，积极表现自己，但求尽心尽力</li>
<li>多看别人的好，适度予以宽容的对待</li>
<li><p>接近拥有心灵智慧的良师益友</p>
<p> 智慧不起烦恼，慈悲没有敌人</p>
</li>
<li><p>提醒自己：世间事都只是过程而非结果</p>
<p>每件事最终都会过去，包括我自己(凡人必有一死)</p>
</li>
<li><p>全力以赴后，放下得失心，因为你没有办法决定所有的事一定如你所愿</p>
<p>战胜对手只是人生的赢家，战胜自己才是命运的强者</p>
</li>
</ol>
<h3 id="哈佛大学推荐20个快乐的习惯"><a href="#哈佛大学推荐20个快乐的习惯" class="headerlink" title="哈佛大学推荐20个快乐的习惯"></a>哈佛大学推荐20个快乐的习惯</h3><ol>
<li><p>be grateful    (学会感恩)</p>
<p> 让自己变慢脚步，看看你的四周，关注生活中的细微之处：人行道上淡紫色的花，美丽的日落，洗去你一天疲惫的淋浴，伴侣眼中的笑容。当你的感恩之心能够欣赏生活的美，思考和祝福，你自然就充满了幸福感。</p>
</li>
<li><p>choose your friedns wisely</p>
<p> 如果你想变得开心的话，要选择和乐观的朋友在一起，他们能欣赏你真实的自己，让你的生活变得更丰富，快乐，有意义。</p>
</li>
<li><p>cultivate compassion (培养同情心)</p>
<p> 当我们代替别人，站在另一个角度看问题，我们更能用同情心，客观和有效的处理问题。生活中就会少一些冲突，多一点快乐。</p>
</li>
<li><p>keep leaning</p>
<p> 学习让我们保持年轻，梦想让我们充满活力。我们运用大脑，进行运作的时候，我们就不大会想不开心心的事情，我们会变得更开心和满足。</p>
</li>
<li><p>become a problem solver (学会解决问题)</p>
</li>
<li>do what you love</li>
<li><p>live in the present</p>
<p> 你感到沮丧，是因为你活在过去。你会感到担忧和焦虑，是因为你活在未来。但是当你感到满足，开心和平和时，你才是活在当下。</p>
</li>
<li><p>laugh often</p>
<p> 　笑是对抗生气或沮丧最有力的的东西。不要把生活看的太严肃。要学会在每日的奋斗中寻找幽默感和笑声。
 　</p>
</li>
<li><p>practice forgiveness</p>
<p> 憎恨和生气是对自我的惩罚。当你释怀的时候，事实上你是在对自己施以善意。最重要的是，学会原谅自己。每个人都犯错。只有通过我们的错误，我们才慢慢学会如何成为一个更强大，更好的人。</p>
</li>
<li><p>say thanks often</p>
<p>对生活中的祝福要学会欣赏。向那些让你生活变好的人，无论或大或小，表达出你的欣赏之情也同样重要。</p>
</li>
<li><p>create deeper connections （学会深交）</p>
<p>我们的幸福感会在和另一个人的深交中不断猛增。专注聆听是加强这种关系纽带和把幸福感带给自己和别人的两个最重要的方面。</p>
</li>
<li><p>keep you agreement</p>
<p>我们的自尊是建立在我们对自己守承诺的情况下。高度的自尊和幸福感有直接关联。所以要对自己和别人遵守承诺。</p>
</li>
<li><p>meditate （冥想）</p>
</li>
<li><p>focus on what you’re doing</p>
<p>当你全身心投入一件事的时候，你就会处于一个开心的状态。当我们处于这种状态，你就不大会关心别人对你怎么看，不大会被不大重要的事情干扰。结果呢？更幸福，当然啦！</p>
</li>
<li><p>be optimistic</p>
<p>对于开心的人来说，玻璃都一直是半满的。每当你面对一个挑战时，如果你倾向于想象最坏的想法，那就自我转换这种情况。告诉你自己一个状况中的好处或者你从中学到的东西。乐观肯定能驱动成功和幸福感。</p>
</li>
<li><p>love unconditionally</p>
<p>没人是完美的,接受你自己所有的不完美,也要这样对待别人。无条件的爱一个人并不意味着你要花所有的时间和他们在一起，或者帮助他们解决问题。无条件的爱意味着接受真实的他们，以他们自己的步伐，让他们自己摸索。</p>
</li>
<li><p>don’t give up</p>
<p>没有完成的方案和不断的失败不可避免的会削弱你的自尊。如果你决定做某事，做完它。</p>
</li>
<li><p>do you best and then let go</p>
<p>每个人都有局限性。而且有时候尽管我们很努力做一件事情，但是总会事与愿违。所以做最好的自己，然后放手。当你尽了全力，你就没有遗憾了。</p>
</li>
<li><p>take care of yourself</p>
<p>一个健康的身体是幸福的关键。如果你身体不好，你无论如何努力，都很难快乐。确信自己吃得好，做锻炼，找点时间休息。好好照顾你的身体，大脑和精神。</p>
</li>
<li><p>give back （学会给予）</p>
<p>做好事是最能确保你心情好的方法之一。根据哈佛，人们做好事，他们的大脑变得活跃，就好像当你经历别的奖励时，大脑所受的刺激。所以，那些关心别人的人要比不大关心别人的人更开心。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="qiubo" />
            
              <p class="site-author-name" itemprop="name">qiubo</p>
              <p class="site-description motion-element" itemprop="description">Keep running!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">65</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/bohrqiu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:bohrqiu@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://qiuduo.me/" title="qiuduo" target="_blank">qiuduo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://thanhong.me/" title="daidai" target="_blank">daidai</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dbalife.info" title="bingwei" target="_blank">bingwei</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2013 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiubo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
