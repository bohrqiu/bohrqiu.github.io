<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="秋波的程序生活" />










<meta name="description" content="Keep running!">
<meta property="og:type" content="website">
<meta property="og:title" content="qiubo&#39;s life">
<meta property="og:url" content="http://bohr.me/page/4/index.html">
<meta property="og:site_name" content="qiubo&#39;s life">
<meta property="og:description" content="Keep running!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="qiubo&#39;s life">
<meta name="twitter:description" content="Keep running!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://bohr.me/page/4/"/>





  <title>qiubo's life</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e81935b4d5ec7e3e782fe240cbd9c21c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">qiubo's life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay Hungry, Stay Foolish</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-09-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-09-reading-notes/" itemprop="url">2014年09月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-28T21:52:17+08:00">
                2014-09-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mcrouter-基于-Memcached协议的缓存层流量管理工具"><a href="#Mcrouter-基于-Memcached协议的缓存层流量管理工具" class="headerlink" title="Mcrouter:基于 Memcached协议的缓存层流量管理工具"></a>Mcrouter:基于 Memcached协议的缓存层流量管理工具</h2><p><a href="http://www.infoq.com/cn/news/2014/09/mcrouter-memcached" target="_blank" rel="noopener">http://www.infoq.com/cn/news/2014/09/mcrouter-memcached</a></p>
<p><a href="https://code.facebook.com/posts/296442737213493/introducing-mcrouter-a-memcached-protocol-router-for-scaling-memcached-deployments/" target="_blank" rel="noopener">https://code.facebook.com/posts/296442737213493/introducing-mcrouter-a-memcached-protocol-router-for-scaling-memcached-deployments/</a></p>
<p>memcache不支持服务端路由,facebook开发了<code>mcrouter</code>(能够处理每秒50亿次的请求).它和memcached之间通过文本协议通信.扮演者memcached服务器的客户端,应用的服务端.他的特性很多,基本上都是我们需要的.我们现在使用的是二进制协议,需要修改为文本协议.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/dubbo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dubbo/" itemprop="url">dubbo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-23T21:52:17+08:00">
                2014-09-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="dubbo的一些分析和优化"><a href="#dubbo的一些分析和优化" class="headerlink" title="dubbo的一些分析和优化"></a>dubbo的一些分析和优化</h1><h2 id="dubbo应用线程分析"><a href="#dubbo应用线程分析" class="headerlink" title="dubbo应用线程分析"></a>dubbo应用线程分析</h2><h3 id="dubbo-remoting-client-heartbeat-thread"><a href="#dubbo-remoting-client-heartbeat-thread" class="headerlink" title="dubbo-remoting-client-heartbeat-thread"></a>dubbo-remoting-client-heartbeat-thread</h3><p>dubbo客户端心跳线程</p>
<p>线程启动类：<code>HeaderExchangeClient</code></p>
<p>任务执行类：<code>HeartBeatTask</code></p>
<p>此任务会定时向服务端发送心跳消息，每个连接一个任务，执行周期默认为60s，执行时会判断此<code>Channel</code>是否在心跳周期类有读写，如果没有，给服务端发送心跳信号.</p>
<p>改进措施：可以给执行线程合理命名。</p>
<h3 id="xxxx-EventThread"><a href="#xxxx-EventThread" class="headerlink" title="xxxx-EventThread"></a>xxxx-EventThread</h3><p>zookeeper事件处理线程</p>
<p>线程启动类：<code>org.apache.zookeeper.ClientCnxn</code></p>
<p>任务执行类：<code>org.apache.zookeeper.ClientCnxn.EventThread</code></p>
<p>此线程的命名格式为<code>启动线程名+EventThread</code>，其中的<code>localhost-startStop-1</code>tomcat启动线程名。</p>
<p>在<code>CuratorFrameworkImpl</code>启动时，会向zookeeper服务器建立连接，此时会创建此线程。</p>
<p>我们必须保证一个应用只有一个<code>CuratorFrameworkImpl</code>实例。</p>
<h3 id="localhost-startStop-1-SendThread"><a href="#localhost-startStop-1-SendThread" class="headerlink" title="localhost-startStop-1-SendThread"></a>localhost-startStop-1-SendThread</h3><p>zookeeper 心跳、发送请求线程</p>
<p>线程启动类：<code>org.apache.zookeeper.ClientCnxn</code></p>
<p>任务执行类：<code>org.apache.zookeeper.ClientCnxn.SendThread</code></p>
<h3 id="DubboClientReconnectTimer-thread"><a href="#DubboClientReconnectTimer-thread" class="headerlink" title="DubboClientReconnectTimer-thread"></a>DubboClientReconnectTimer-thread</h3><p>消费者连接服务提供者的定时重连任务，默认执行周期2s，检查是否连接，没有连接重新连接。</p>
<p>线程启动类：<code>com.alibaba.dubbo.remoting.transport.AbstractClient</code></p>
<p>任务执行类：<code>com.alibaba.dubbo.remoting.transport.AbstractClient$1</code></p>
<h3 id="DubboServerHandler"><a href="#DubboServerHandler" class="headerlink" title="DubboServerHandler-"></a>DubboServerHandler-</h3><p>dubbo服务端，任务处理线程,处理客户端请求</p>
<p>线程池启动类:<code>AllChannelHandler</code>的构造器中初始化线程池</p>
<p>线程池实际创建类：<code>FixedThreadPool</code></p>
<p>任务处理类：<code>com.alibaba.dubbo.remoting.transport.DecodeHandler</code></p>
<h3 id="DubboClientHandler"><a href="#DubboClientHandler" class="headerlink" title="DubboClientHandler-"></a>DubboClientHandler-</h3><p>此线程主要用于dubbo客户端处理服务端的响应/连接相关事件，netty在接受到消息后，交给此线程池来处理。</p>
<p>线程启动类：<code>com.alibaba.dubbo.remoting.transport.AbstractClient#wrapChannelHandler</code></p>
<p>线程池实际创建类：<code>CachedThreadPool</code></p>
<p>任务处理类：<code>com.alibaba.dubbo.remoting.transport.DecodeHandler</code></p>
<h3 id="DubboRegistryFailedRetryTimer"><a href="#DubboRegistryFailedRetryTimer" class="headerlink" title="DubboRegistryFailedRetryTimer"></a>DubboRegistryFailedRetryTimer</h3><p>当dubbo和注册中心的相关请求(注册、取消注册、订阅、取消订阅)处理失败时，会暂时放在缓存中，此定时任务会周期性的来处理这些失败的请求</p>
<p>线程启动类：<code>com.alibaba.dubbo.registry.support.FailbackRegistry</code></p>
<p>处理任务：<code>com.alibaba.dubbo.registry.support.FailbackRegistry#retry</code></p>
<h3 id="DubboSaveRegistryCache"><a href="#DubboSaveRegistryCache" class="headerlink" title="DubboSaveRegistryCache"></a>DubboSaveRegistryCache</h3><p>异步保存服务提供者地址</p>
<p>线程启动类：<code>com.alibaba.dubbo.registry.support.AbstractRegistry</code></p>
<p>任务执行类：<code>com.alibaba.dubbo.registry.support.AbstractRegistry.SaveProperties</code></p>
<h3 id="DubboResponseTimeoutScanTimer"><a href="#DubboResponseTimeoutScanTimer" class="headerlink" title="DubboResponseTimeoutScanTimer"></a>DubboResponseTimeoutScanTimer</h3><p>扫描等待返回的<code>DefaultFuture</code>对象，如果<code>DefaultFuture</code>超时，则抛出超时异常。</p>
<p>任务类:<code>DefaultFuture.RemotingInvocationTimeoutScan</code></p>
<p>优化意见：目前的方式是间隔30ms就去扫描一次，建议重写<code>ConcurrentHashMap</code>缓存，加入队列等待机制。</p>
<h2 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h2><p><code>com.alibaba.dubbo.remoting.transport.dispatcher.ChannelEventRunnable</code>处理netty的事件，他会把telnet请求(decode后为文本)代理给<code>com.alibaba.dubbo.remoting.telnet.support.TelnetHandlerAdapter</code>来处理。</p>
<h2 id="dubbo线程池任务不均衡问题分析"><a href="#dubbo线程池任务不均衡问题分析" class="headerlink" title="dubbo线程池任务不均衡问题分析"></a>dubbo线程池任务不均衡问题分析</h2><p>dubbo应用使用的线程池为<code>com.alibaba.dubbo.common.threadpool.support.fixed.FixedThreadPool</code>,如果当queue设置为0时,会使用<code>SynchronousQueue</code>,这个东东导致了任务线程执行”不均衡”(满足了大家的心理预期,其实这种不均衡方式减少了上下文切换,但是<code>SynchronousQueue</code>没有大小,不能起到任务缓冲的作用).</p>
<p>请在dubbo:protocol上加上queues大小(参考tomcat默认配置).</p>
<pre><code>&lt;dubbo:protocol name=&quot;dubbo&quot; port=&quot;${dubbo.provider.port}&quot; threads=&quot;200&quot; queues=&quot;100&quot;/&gt;
</code></pre><p>测试:</p>
<p>修改前:</p>
<pre><code>grep DubboServerHandler dubbo-demo.log |awk  -F &apos;-&apos;  &apos;{print $6}&apos; |awk  -F &apos;]&apos;  &apos;{print $1}&apos; |sort -n |uniq -c

  1 150
  1 168
  1 169
  1 170
  ...
  117 171
  5386 172
  714 173
      2646 174
</code></pre><p>修改后:</p>
<pre><code>grep DubboServerHandler dubbo-demo.log |awk  -F &apos;-&apos;  &apos;{print $6}&apos; |awk  -F &apos;]&apos;  &apos;{print $1}&apos; |sort -n |uniq -c
507 1
498 2
 ...
493 199
489 200
</code></pre><h2 id="线程池优化"><a href="#线程池优化" class="headerlink" title="线程池优化"></a>线程池优化</h2><p>jdk默认线程池实现策略如下：</p>
<ol>
<li>当线程数少于corePoolSize，总是新建线程</li>
<li>当线程数=corePoolSize时，所有线程都忙，就会把线程放入队列；当队列满时，才会继续创建线程</li>
<li>当线程数量=maxPoolSize并且队列也满时，<code>RejectedExecutionHandler</code>生效。</li>
</ol>
<p>易极付内部对线程池做了些优化：</p>
<ol>
<li>我们希望能充分利用资源，仅当线程数量=maxPoolSize时，才放入队列。当线程空闲时，线程池收缩到corePoolSize。</li>
<li>当队列设置得比较小的时候，即便线程数量&lt;maxPoolSize,在高并发下也会触发<code>RejectedExecutionHandler</code></li>
<li>线程池没有传递<code>MDC</code>或者应用请求<code>gid</code>。</li>
</ol>
<p>对于1，2，可以参考tomcat内部的线程池实现<code>org.apache.tomcat.util.threads.ThreadPoolExecutor</code>和<code>org.apache.tomcat.util.threads.TaskQueue</code>来改造。</p>
<p>对于3，wrap原任务即可，大致代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MDCGidCallable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;T&gt; task;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String gid;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MDCGidCallable</span><span class="params">(Callable&lt;T&gt; task, String gid)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.task = task;</span><br><span class="line">		<span class="keyword">this</span>.gid = gid;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			MDC.put(GID_KEY, gid);</span><br><span class="line">			<span class="keyword">return</span> task.call();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			MDC.remove(GID_KEY);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="缓存扩展"><a href="#缓存扩展" class="headerlink" title="缓存扩展"></a>缓存扩展</h2><p>下面是我们自己实现的cache机制，个人感觉比dubbo原生的清爽，通过dubbo filter实现。</p>
<p>源代码见<a href="https://github.com/bohrqiu/dubbo-cache" target="_blank" rel="noopener">dubbo-cache</a></p>
<p>blog 参考<a href="http://bohr.me/dubbo-cache/">@DubboCache</a></p>
<h2 id="dubbo-mock"><a href="#dubbo-mock" class="headerlink" title="dubbo mock"></a>dubbo mock</h2><p>mock最好是有mock server。由于懒，把mock server的client实现了(拦截请求，转换为http+json调用到mock server)，后面就没时间做mock server了。前段时间有个项目紧急需要，做了个简单的mock。</p>
<p>原理如下：</p>
<h3 id="对于使用者："><a href="#对于使用者：" class="headerlink" title="对于使用者："></a>对于使用者：</h3><ol>
<li><p>用户配置需要mock的dubbo服务。</p>
<p> 比如： <code>dubbo.consumer.mockInterfaces[0]=com.acooly.core.test.dubbo.mock.XXFacade</code></p>
</li>
<li><p>增加mock实现。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXFacadeMock</span> <span class="keyword">implements</span> <span class="title">XXFacade</span> </span>&#123;</span><br><span class="line">	 <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SingleResult&lt;String&gt; <span class="title">echo</span><span class="params">(SingleOrder&lt;String&gt; msg)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SingleResult.from(<span class="string">"mocked"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="组件提供的能力"><a href="#组件提供的能力" class="headerlink" title="组件提供的能力"></a>组件提供的能力</h3><ol>
<li>自定义实现<code>BeanPostProcessor</code>,扫描所有标注<code>@Reference</code>注解的属性，如果被配置了要mock掉，设置属性为mock实现。</li>
</ol>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>最后附带一个在易极付写的dubbo分享。</p>


	<div class="row">
    <embed src="dubbo.pdf" width="100%" height="550" type="application/pdf">
	</div>




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/zero-copy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/zero-copy/" itemprop="url">使用零拷贝提高数据传输效率</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-08-16T21:52:17+08:00">
                2014-08-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文讲了如何用<code>zero copy</code>技术来提高I/O性能.</p>
<p>静态文件服务器需要把磁盘上的数据发送给客户端.这里cpu消耗比较少,但是效率不高:内核从磁盘读数据,内核/用户空间交换数据,最后写到socket.数据在内核/用户空间转换时,需要拷贝数据,消耗cpu和内存带宽.对于java应用来说,还需要合理的使用缓冲区来减少gc的压力.</p>
<p>java提供了<code>transferTo</code>方法来使用<code>zero copy</code>技术.他可以让数据直接从一个<code>channel</code>到另外一个<code>channel</code>.避免上面说到的一些问题.</p>
<h3 id="1-传统的解决办法"><a href="#1-传统的解决办法" class="headerlink" title="1.传统的解决办法"></a>1.传统的解决办法</h3><p>过程类似于下面的代码:</p>
<pre><code>File.read(fileDesc, buf, len);
Socket.send(socket, buf, len);
</code></pre><h4 id="1-1数据拷贝"><a href="#1-1数据拷贝" class="headerlink" title="1.1数据拷贝"></a>1.1数据拷贝</h4><p><img src="/zero-copy/figure1.gif" alt=""></p>
<p>这种方式会有四次内存拷贝</p>
<h4 id="1-2-上下文切换"><a href="#1-2-上下文切换" class="headerlink" title="1.2 上下文切换"></a>1.2 上下文切换</h4><p><img src="/zero-copy/figure2.gif" alt=""></p>
<p>这种方式会有四次上下文切换.</p>
<h4 id="1-3-过程说明"><a href="#1-3-过程说明" class="headerlink" title="1.3 过程说明"></a>1.3 过程说明</h4><ol>
<li><code>read</code>方法导致一次从<code>user mode</code>到<code>kernel mode</code>的上下文切换.系统调用<code>sys_read</code>从文件读取数据,通过DMA,把磁盘上的数据读到<code>kernel address space buffer</code>.</li>
<li>数据从<code>kernel address space buffer</code>拷贝到<code>user buffer</code>.<code>read</code>返回,导致从<code>kernel mode</code>到<code>user mode</code>的上下文切换.现在数据被读到了<code>user address space buffer</code>.</li>
<li><code>send</code>方法导致一次<code>user mode</code>到<code>kernel mode</code>的上下文切换.第三次拷贝把拷贝到<code>kernel address space buffer</code>.此buffer关联着<code>destination socket</code></li>
<li>系统<code>send</code>调用返回时导致第四次上下文切换,DMA把<code>kernel address space buffer</code>中的数据发送到协议引擎导致第四次数据拷贝.</li>
</ol>
<h4 id="1-4-intermediate-kernel-buffer"><a href="#1-4-intermediate-kernel-buffer" class="headerlink" title="1.4 intermediate kernel buffer"></a>1.4 intermediate kernel buffer</h4><p>使用<code>intermediate kernel buffer</code>主要为了提高性能,读的时候扮演缓存的角色,写的时候可以让应用程序实现异步(应用程序写到kernel buffer就返回).不幸的是,当我们处理的数据大于内核缓冲大小时,这样的拷贝是完全没有任何意义的.</p>
<h3 id="2-零拷贝的方式"><a href="#2-零拷贝的方式" class="headerlink" title="2.零拷贝的方式"></a>2.零拷贝的方式</h3><p>使用如下的代码来完成零拷贝</p>
<p>java方法:</p>
<pre><code>public void transferTo(long position, long count, WritableByteChannel target);
</code></pre><p>系统调用:</p>
<pre><code>#include &lt;sys/socket.h&gt;
ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
</code></pre><h4 id="2-1-数据拷贝"><a href="#2-1-数据拷贝" class="headerlink" title="2.1 数据拷贝"></a>2.1 数据拷贝</h4><p><img src="/zero-copy/figure3.gif" alt=""></p>
<p>涉及到3次数据拷贝.</p>
<h4 id="2-2-上下文切换"><a href="#2-2-上下文切换" class="headerlink" title="2.2 上下文切换"></a>2.2 上下文切换</h4><p><img src="/zero-copy/figure4.gif" alt=""></p>
<p>涉及到2次上下文切换</p>
<h4 id="2-3-过程说明"><a href="#2-3-过程说明" class="headerlink" title="2.3 过程说明"></a>2.3 过程说明</h4><ol>
<li><code>transferTo</code>方法让DMA把磁盘文件读到<code>kernel read buffer</code>.然后内核把<code>kernel read buffer</code>中的数据拷贝到<code>socket buffer</code>.</li>
<li><code>DMA</code>把<code>socket buffer</code>中的数据拷贝到协议引擎.</li>
</ol>
<h3 id="3-更好的方式"><a href="#3-更好的方式" class="headerlink" title="3 更好的方式"></a>3 更好的方式</h3><p>通过上面使用这种方式,上下文切换从4次变为了2次.数据拷贝减少了一次.如果网卡支持<code>gather operations</code>,linux 2.4内核就开始提供更好的解决方案.</p>
<p><img src="/zero-copy/figure5.gif" alt=""></p>
<ol>
<li><code>transferTo</code>方法让<code>DMA engine</code>把磁盘文件内容拷贝到内核缓冲区.</li>
<li>数据不需要拷贝到<code>socket buffer</code>.<code>socket buffer</code>里只需写入数据的地址和长度.<code>DMA engine</code>从内核缓冲区把数据读到协议引擎.</li>
</ol>
<p>通过内核带来的特性,数据拷贝变为了2次(这两次拷贝都是DMA在做).cpu copy变为了0.</p>
<h3 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4 写在最后"></a>4 写在最后</h3><p>文章地址<code>http://www.ibm.com/developerworks/library/j-zerocopy/</code>,里面有性能测试结果.后面附带有性能测试程序.不过这个测试程序不太恰当,应该都用nio的api来测试<code>tansferTo</code>和非<code>tansferTo</code>.</p>
<p>静态文件服务器一般都有静态资源缓存(apache可以配置,其他的服务器不了解).如果使用内存缓存,减少了读的过程.内存拷贝变为cpu copy <code>application buffer</code> -&gt; <code>socket buffer</code>,DMA copy <code>socket buffer</code> -&gt;<code>NIC buffer</code>,磁盘io大大降低了.</p>
<p><code>NIO</code>不是很熟悉,不知道通过<code>ByteBuffer.allocateDirect()</code>+<code>transferTo</code>+<code>gather operations</code>能不能让copy变为一次.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/database-version/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/database-version/" itemprop="url">如何跟踪数据库结构变动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-08-15T21:52:17+08:00">
                2014-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天和澎湃聊了这个事情,当时的想法是数据库中有表记录版本,项目代码中存储变更脚本.无意中看到数据库版本控制工具<a href="http://www.liquibase.org/index.html" target="_blank" rel="noopener">liquibase</a>.最开始还是有点担心,怕这东西把数据库玩坏了.看了看官方文档,再粗略看了下主流程的源代码,发掘下我想要的功能,这个工具已经足够强大了,我们用好就行.</p>
<p>下面以cs为例,讲讲整个过程.</p>
<h3 id="1-在cs-dal中添加maven依赖"><a href="#1-在cs-dal中添加maven依赖" class="headerlink" title="1. 在cs-dal中添加maven依赖."></a>1. 在cs-dal中添加maven依赖.</h3><pre><code>    &lt;build&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.liquibase&lt;/groupId&gt;
            &lt;artifactId&gt;liquibase-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.2.2&lt;/version&gt;
            &lt;configuration&gt;
                &lt;!--数据库变更主文件--&gt;
                &lt;changeLogFile&gt;src/main/resources/db/changelog/db.master.xml&lt;/changeLogFile&gt;
                &lt;!--数据库相关配置文件--&gt;
                &lt;propertyFile&gt;src/main/resources/db/config/dal-${spring.profiles.active}.properties&lt;/propertyFile&gt;
            &lt;/configuration&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;phase&gt;process-resources&lt;/phase&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;update&lt;/goal&gt;
                    &lt;/goals&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre><h3 id="2-编写数据库变更脚本"><a href="#2-编写数据库变更脚本" class="headerlink" title="2. 编写数据库变更脚本"></a>2. 编写数据库变更脚本</h3><h4 id="2-1-数据库变更主文件"><a href="#2-1-数据库变更主文件" class="headerlink" title="2.1 数据库变更主文件"></a>2.1 数据库变更主文件</h4><p><code>db.master.xml</code>:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;databaseChangeLog
    xmlns=&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://www.liquibase.org/xml/ns/dbchangelog
     http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd&quot;&gt;
    &lt;!--数据库变更文件.注意:保证顺序,脚本执行顺序和include的先后有关系.includeAll可以加载所有脚本,加载顺序和文件命名有关系,容易犯错误,建议不使用.--&gt;
    &lt;include relativeToChangelogFile=&quot;true&quot; file=&quot;db.1.0.sql&quot;/&gt;
       &lt;include relativeToChangelogFile=&quot;true&quot; file=&quot;db.2.0.sql&quot;/&gt;
&lt;/databaseChangeLog&gt;
</code></pre><h4 id="2-2-变更脚本"><a href="#2-2-变更脚本" class="headerlink" title="2.2 变更脚本"></a>2.2 变更脚本</h4><p><code>db.1.0.sql</code>:</p>
<pre><code>--liquibase formatted sql

--changeset qiubo:1
create table test1 (
    id int primary key,
    name varchar(255)
);
--rollback drop table test1;
</code></pre><p><code>db.2.0.sql</code>:</p>
<pre><code>--liquibase formatted sql

--changeset qiubo:2
insert into test1 (id, name) values (1, &apos;name 1&apos;);
insert into test1 (id, name) values (2, &apos;name 2&apos;);
</code></pre><p>语法参考:<a href="http://www.liquibase.org/documentation/sql_format.html" target="_blank" rel="noopener">http://www.liquibase.org/documentation/sql_format.html</a></p>
<h4 id="2-3-数据库配置文件"><a href="#2-3-数据库配置文件" class="headerlink" title="2.3 数据库配置文件"></a>2.3 数据库配置文件</h4><p>dal-local.properties</p>
<pre><code>driver=com.mysql.jdbc.Driver
url=jdbc:mysql://127.0.0.1:3306/yjf_cs?useUnicode=true&amp;characterEncoding=UTF8&amp;zeroDateTimeBehavior=convertToNull
username=root
password=root
#数据库schema名
changelogSchemaName=yjf_cs
</code></pre><p>建议大家把原来的数据库配置文件中的key改为和这个一致,没必要搞多份配置.</p>
<h3 id="3-路径结构"><a href="#3-路径结构" class="headerlink" title="3.路径结构"></a>3.路径结构</h3><p>确保xxx-dal如下的路径结构,请大家统一:</p>
<pre><code>|---pom.xml
|---src
|    |---main
|    |    |---java
|    |    |---resources
|    |    |        |---db
|    |    |        |    |---changelog
|    |    |        |    |        |---db.1.0.sql
|    |    |        |    |        |---db.2.0.sql
|    |    |        |    |        |---db.master.xml
|    |    |        |    |---config
|    |    |        |    |     |---dal-dev.properties
|    |    |        |    |     |---dal-local.properties
|    |    |        |    |     |---dal-net.properties
|    |    |        |    |     |---dal-online.properties
|    |    |        |    |     |---dal-pnet.properties
|    |    |        |    |     |---dal-sdev.properties
|    |    |        |    |     |---dal-snet.properties
|    |    |        |    |     |---dal-stest.properties
|    |    |        |    |     |---dal-test.properties
</code></pre><h3 id="4-执行"><a href="#4-执行" class="headerlink" title="4.执行"></a>4.执行</h3><p>在cs-dal目录执行:</p>
<pre><code>mvn liquibase:update -Dspring.profiles.active=local
</code></pre><p>上面的脚本会以local环境执行,读取<code>dal-local.properties</code>中的数据库配置,执行数据库变更脚本.执行成功后,会在数据库中新建两个表.<code>DATABASECHANGELOG</code>会记录数据库变更信息,<code>DATABASECHANGELOGLOCK</code>用于防止多台服务器同时部署时的并发问题.</p>
<h3 id="5-注意事项"><a href="#5-注意事项" class="headerlink" title="5.注意事项"></a>5.注意事项</h3><ol>
<li>先不要搞线上.</li>
<li>变更脚本命名:我现在做得简单<code>db.1.0.sql</code>,最好版本号为项目版本号,便于跟踪.</li>
<li>新项目建议采用此方案,跟踪数据库所有的开发变动.</li>
<li>老项目可以采用全量的方式使用.全量,先根据数据库的基础数据生成变更脚本<a href="http://www.liquibase.org/documentation/generating_changelogs.html" target="_blank" rel="noopener">generating_changelogs</a>,然后同步版本(changeLogSync)到数据库中.这样做的好处是,以后可以从无到有的创建当前版本的数据库了.参考<a href="http://www.liquibase.org/documentation/existing_project.html" target="_blank" rel="noopener">Adding Liquibase on an Existing project</a></li>
<li>老项目也可以采用增量的方式使用,增量的方式不会管以前的数据版本.如果采用这种方式,在新环境搭建数据库,你需要先用数据库工具还原到没有版本之前的状态,然后再执行变更脚本.参考<a href="http://www.liquibase.org/documentation/existing_project.html" target="_blank" rel="noopener">Adding Liquibase on an Existing project</a></li>
<li>请不要修改(脚本内容/脚本路径)之前的数据库变更脚本,liquibase会对每个Changesets生成摘要,执行时会去对比,如果你修改了以前的Changesets,会报错(所有的变更在事务中执行,出错了会回滚,不用担心会影响到数据库).</li>
<li>官方文档很全,想深入的同学请阅读<a href="http://www.liquibase.org/faq.html" target="_blank" rel="noopener">FAQ</a>/<a href="http://www.liquibase.org/bestpractices.html" target="_blank" rel="noopener">BEST PRACTICES</a>/<a href="http://www.liquibase.org/documentation/maven/index.html" target="_blank" rel="noopener">Maven Liquibase Plugin</a>.遇到问题之前先检查配置是否正确,有bug可以找我^_^.</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/cxf-tuning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/cxf-tuning/" itemprop="url">webservice优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-08-14T21:52:17+08:00">
                2014-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很早之前写的一篇文字,一直没有搬上blog,以后会慢慢把有些东西放到blog上来.</p>
<p>webservice的性能实在是敢恭维。曾经因为webservice吞吐量上不去，对webservice进行了一些性能方面的优化:</p>
<h2 id="1-分析"><a href="#1-分析" class="headerlink" title="1.分析"></a>1.分析</h2><h3 id="1-1-FastInfoset"><a href="#1-1-FastInfoset" class="headerlink" title="1.1 FastInfoset"></a>1.1 FastInfoset</h3><p>采用了<a href="http://en.wikipedia.org/wiki/Fast_Infoset" target="_blank" rel="noopener">FastInfoset</a>(简称FI)，效果很明显，极端条件下的大数据量传输，性能提高60%，他可以减少传输成本，序列化成本和xml解析成本。cxf基于http协商机制(检查请求header中<code>Accept: application/fastinfoset</code>)来启用FI。</p>
<h3 id="1-2-Gzip"><a href="#1-2-Gzip" class="headerlink" title="1.2 Gzip"></a>1.2 Gzip</h3><p>客户端和服务器端是否使用Gzip压缩，也是基于http协议协商的(检查请求header 中是否有<code>Accept-encoding:gzip</code>)。但是这里需要仔细权衡下。对于小数据量，启用gzip压缩支持是吃力不讨好的行为，数据量很小的时候，gzip压缩结果不明显，还浪费cpu。</p>
<h3 id="1-3-unexpected-element异常"><a href="#1-3-unexpected-element异常" class="headerlink" title="1.3 unexpected element异常"></a>1.3 unexpected element异常</h3><p>见:<a href="http://bohr.me/cxf-unexpected-element/">http://bohr.me/cxf-unexpected-element/</a></p>
<h3 id="1-4-处理过程分析"><a href="#1-4-处理过程分析" class="headerlink" title="1.4 处理过程分析"></a>1.4 处理过程分析</h3><p>cxf 中通过一些列interceptor来完成数据解析处理操作，每个interceptor绑定到特定的阶段，下面是GZIP 和FI interceptor所处的阶段</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>Direction</th>
<th>Phase</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gzip</td>
<td>IN</td>
<td>Phase.RECEIVE</td>
</tr>
<tr>
<td></td>
<td>Out</td>
<td>Phase.PREPARE_SEND</td>
</tr>
<tr>
<td> FI</td>
<td>IN</td>
<td>Phase.POST_STREAM</td>
</tr>
<tr>
<td></td>
<td>Out</td>
<td>Phase.PRE_STREAM</td>
</tr>
</tbody>
</table>
<p>数据进来时，先<code>RECEIVE</code>阶段适配InputStream对象为GZIPInputStream，然后在<code>POST_STREAM</code>阶段解析数据。完成gzip解压缩，FI解析数据过程。</p>
<p>数据出去时，在<code>PREPARE_SEND</code>阶段适配OutputStream对象为GZipThresholdOutputStream，在<code>PRE_STREAM</code>阶段再序列化为二进制数据传输出去。完成FI序列化数据，GZIP压缩数据过程。</p>
<p>测试发送20250byte数据，仅仅启用FI时，发送数据量为20181byte，再启用Gzip压缩后，发送数据量为258byte。</p>
<h2 id="2-操作步骤"><a href="#2-操作步骤" class="headerlink" title="2.操作步骤"></a>2.操作步骤</h2><h3 id="2-1添加依赖"><a href="#2-1添加依赖" class="headerlink" title="2.1添加依赖"></a>2.1添加依赖</h3><p>cxf版本修改为2.7.0并加入FastInfoset</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.sun.xml.fastinfoset&lt;/groupId&gt;
    &lt;artifactId&gt;FastInfoset&lt;/artifactId&gt;
    &lt;version&gt;1.2.9&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h3 id="2-2-修改cxf配置"><a href="#2-2-修改cxf配置" class="headerlink" title="2.2    修改cxf配置"></a>2.2    修改cxf配置</h3><h4 id="2-2-1-删除引入的cxf配置"><a href="#2-2-1-删除引入的cxf配置" class="headerlink" title="2.2.1 删除引入的cxf配置"></a>2.2.1 删除引入的cxf配置</h4><pre><code>&lt;import resource=&quot;classpath:META-INF/cxf/cxf.xml&quot; /&gt;
&lt;import resource=&quot;classpath:META-INF/cxf/cxf-extension-soap.xml&quot; /&gt;
&lt;import resource=&quot;classpath:META-INF/cxf/cxf-servlet.xml&quot; /&gt;
</code></pre><p>我们项目中很多spring配置文件都加入了上面的东东，这个不是必须的，不删除这东东会导致配置不生效。</p>
<h4 id="2-2-2-配置gzip和FI"><a href="#2-2-2-配置gzip和FI" class="headerlink" title="2.2.2 配置gzip和FI"></a>2.2.2 配置gzip和FI</h4><p>Spring配置文件中引入cxf namespace<br><code>xmlns:cxf=http://cxf.apache.org/core和xsi:schemaLocation
http://cxf.apache.org/core  http://cxf.apache.org/schemas/core.xsd</code></p>
<p>然后加入配置</p>
<pre><code>&lt;cxf:bus&gt;
    &lt;cxf:features&gt;
        &lt;cxf:fastinfoset force=&quot;false&quot; /&gt;
        &lt;bean class=&quot;org.apache.cxf.transport.common.gzip.GZIPFeature&quot;&gt;
            &lt;property name=&quot;threshold&quot;&gt;
                &lt;value&gt;2048&lt;/value&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    &lt;/cxf:features&gt;
&lt;/cxf:bus&gt;
</code></pre><p>注意这些特性client和server端都要配置。</p>
<h2 id="3-写在最后"><a href="#3-写在最后" class="headerlink" title="3.写在最后"></a>3.写在最后</h2><p>启用<code>gzip</code>和<code>FastInfoset</code>,性能基本上也到达webservice的极致了.通过<code>IgnoreUnexpectedElementValidationEventHandler</code>再解决易用性问题,基本完美.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/monitor-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/monitor-tools/" itemprop="url">java开发工程师可以了解的常用命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-08-06T21:52:17+08:00">
                2014-08-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先总结下常用的一些监控工具:</p>
<h2 id="linux命令"><a href="#linux命令" class="headerlink" title="linux命令"></a>linux命令</h2><ul>
<li><p><code>w</code></p>
<p>  系统负载</p>
</li>
<li><p><code>lsof -p pid</code></p>
<p>  进程打开的文件</p>
</li>
<li><p><code>lsof -i:port</code></p>
<p>  端口的运行情况</p>
</li>
<li><p><code>free -m</code></p>
<p>  内存情况</p>
</li>
<li><p><code>vmstat</code></p>
<p>  进程、内存、内存分页、堵塞IO、traps及CPU活动的信息</p>
</li>
<li><p><code>iostat</code></p>
<p>  磁盘io情况</p>
</li>
<li><p><code>top -n 1</code></p>
<p>  cpu/负载/内存等使用情况.</p>
</li>
<li><p><code>iotop</code></p>
<p>  磁盘io</p>
</li>
<li><p><code>ps aux | sort -k6nr | head -n 10</code></p>
<p>  查看linux 实际内存占用最多的10个</p>
</li>
<li><p><code>ps aux | sort -k5nr | head -n 10</code></p>
<p>  查看linux 虚拟内存占用最多的10个</p>
</li>
<li><p><code>dstat -lamps</code></p>
<p>  查看系统整体状况</p>
</li>
<li><p><code>pstree -al pid|head -n 1</code></p>
<p>  查看进程启动命令</p>
</li>
<li><p><code>strace -T -p pid</code></p>
<p>  查看进程系统调用.开销很大,使用时要小心.</p>
</li>
<li><p><code>netstat</code></p>
<p>  <code>netstat -an |grep port</code> 查看端口连接情况</p>
<p>  <code>netstat -alnp |grep pid</code> 通过pid查看进程所有端口情况</p>
</li>
<li><p><code>ss -lntp |grep port</code></p>
<p>  通过端口查看进程</p>
</li>
<li><p><code>nmon</code></p>
<p>  强大的监控工具.也可以方便的出报表.我一般用来在压力测试时监控系统性能.</p>
</li>
<li><p><code>latencytop</code></p>
<p>  用于查看系统内部慢.以前做mysql性能优化,多亏有这东东.</p>
</li>
<li><p><code>cat /proc/pid/status  |grep Threads</code></p>
<p>  查看进程内线程个数</p>
</li>
</ul>
<h2 id="java工具"><a href="#java工具" class="headerlink" title="java工具"></a>java工具</h2><ul>
<li><p><code>jvisualvm</code></p>
<p>  jvm的运行情况/各种dump的分析都可以干,没有JRMC牛.oracle承诺会把JRockit的特性迁移到HotSpot上面来.现在jdk下已经有jmc了.</p>
</li>
<li><p><code>jps -lv</code></p>
<p>  查看所有java进程.</p>
</li>
<li><p><code>jinfo -sysprops pid</code></p>
<p>  查看java进程系统参数</p>
</li>
<li><p><code>jinfo  -flag jvmflag pid</code></p>
<p>  查看jvm flag.比如查看xss,<code>jinfo  -flag ThreadStackSize pid</code></p>
</li>
<li><p><code>jstack pid</code></p>
<p>  查看线程栈信息</p>
</li>
<li><p><code>jmap -dump:live,format=b,file=xxx.hprof pid</code></p>
<p>  生成heap dump</p>
</li>
<li><p><code>jmap -histo pid</code></p>
<p>  查看java堆中对象统计信息</p>
</li>
<li><p><code>java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal</code> </p>
<p>  查看jvm flag</p>
<pre><code>The first column appears to reflect the data type of the option (intx, uintx, uint64_t, bool, double, ccstr, ccstrlist). 
The second column is the name of the flag and the third column is the value, if any, that the flag is set to.
The fourth column appears to indicate the type of flag and has values such as {product},{pd product}, {C1 product} for client or {C2 product} for server, {C1 pd product} for client or {C2 pd product} for server, {product rw}, {diagnostic} 
(only if -XX:+UnlockDiagnosticVMOptions was specified), {experimental}, and {manageable}. See Eugene Kuleshov&apos;s The most complete list of -XX options for Java 6 JVM for a brief description of most of these categories as well as a listing of most of these options themselves.
</code></pre></li>
<li><p><a href="http://visualvm.java.net/plugins.html​" target="_blank" rel="noopener">tda</a></p>
<p>  线程栈分析器,这个是jvisualvm的插件.</p>
</li>
<li><p><a href="http://www.eclipse.org/mat/" target="_blank" rel="noopener">mat</a></p>
<p>  基于eclipse的heap dump分析工具,这个工具是比jvisualvm在heap分析这块专业.不过jvisualvm能cover住大多数场景,基本上我都只用jvisualvm了.</p>
</li>
<li><p><code>jmap -heap pid</code></p>
<p>  检查heap情况</p>
</li>
<li><p><a href="https://github.com/chewiebug/GCViewer" target="_blank" rel="noopener">GCViewer</a></p>
<p>  GC日志分析</p>
</li>
<li><p><code>jstat  -gcutil pid</code></p>
<p>  查看gc总体情况</p>
<pre><code>S0  — Heap上的 Survivor space 0 区已使用空间的百分比
S1  — Heap上的 Survivor space 1 区已使用空间的百分比
E   — Heap上的 Eden space 区已使用空间的百分比
O   — Heap上的 Old space 区已使用空间的百分比
P   — Perm space 区已使用空间的百分比
YGC — 从应用程序启动到采样时发生 Young GC 的次数
YGCT– 从应用程序启动到采样时 Young GC 所用的时间(单位秒)
FGC — 从应用程序启动到采样时发生 Full GC 的次数
FGCT– 从应用程序启动到采样时 Full GC 所用的时间(单位秒)
GCT — 从应用程序启动到采样时用于垃圾回收的总时间(单位秒)
</code></pre></li>
<li><p><code>btrace</code></p>
<p>  神器,线上出问题了,想知道某个方法的调用情况,入参之类的,就靠btrace了.<br>此工具大致原理如下:</p>
<ol>
<li><code>btrace-client</code> attach 目标进程(<code>com.sun.tools.attach.VirtualMachine#attach</code>)</li>
<li>加载agent <code>btrace-agent</code> (<code>com.sun.tools.attach.VirtualMachine#loadAgent</code>)</li>
<li>agent启动服务端,开启监听端口</li>
<li><code>brace-client</code> 把编译好的用户btrace代码发送到服务端,并等待服务端响应</li>
<li><code>btrace-agent</code> 通过asm修改运行时代码,织入用户btrace代码逻辑.监控到信息后,发给<code>btrace-client</code></li>
</ol>
</li>
<li><p>jmc</p>
<p>  生成记录</p>
<pre><code>#检查特性是否开启
jcmd 23385 VM.check_commercial_features
#开启商业特性
jcmd 23385 VM.unlock_commercial_features
#检查JFR状态
jcmd 23385 JFR.check
#执行180sJFR收集
jcmd 23385 JFR.start name=recording filename=/root/recording.jfr duration=180s
</code></pre></li>
<li><p>vjtools</p>
<p>  <a href="https://github.com/vipshop/vjtools" target="_blank" rel="noopener">https://github.com/vipshop/vjtools</a> 主要工具vjtop非常有用，打印JVM概况及繁忙线程</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-08-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-08-reading-notes/" itemprop="url">2014年08月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-08-03T21:52:17+08:00">
                2014-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="My-WordPress-Development-Toolbox"><a href="#My-WordPress-Development-Toolbox" class="headerlink" title="My WordPress Development Toolbox"></a>My WordPress Development Toolbox</h2><p><a href="http://tommcfarlin.com/wordpress-developer-toolbox/" target="_blank" rel="noopener">http://tommcfarlin.com/wordpress-developer-toolbox/</a></p>
<p>本来是准备找git的客户端,看到这篇文章.不喜欢tower,大爱<a href="http://www.sourcetreeapp.com/" target="_blank" rel="noopener">SoureTree</a>.</p>
<p><a href="http://www.browserstack.com/" target="_blank" rel="noopener">browserstack</a>也挺好的,适合做浏览器兼容性测试.</p>
<h2 id="JVM-plus-Docker-Better-together"><a href="#JVM-plus-Docker-Better-together" class="headerlink" title="JVM plus Docker: Better together"></a>JVM plus Docker: Better together</h2><p><a href="http://www.javaworld.com/article/2456960/java-app-dev/jvm-plus-docker-better-together.html" target="_blank" rel="noopener">http://www.javaworld.com/article/2456960/java-app-dev/jvm-plus-docker-better-together.html</a></p>
<p>docker刚好弥补jvm对资源管理(CPU/IO)的不足.</p>
<h2 id="SharedHashMap-vs-Redis"><a href="#SharedHashMap-vs-Redis" class="headerlink" title="SharedHashMap vs Redis"></a>SharedHashMap vs Redis</h2><p><a href="http://vanillajava.blogspot.jp/2014/05/sharedhashmap-vs-redis.html" target="_blank" rel="noopener">http://vanillajava.blogspot.jp/2014/05/sharedhashmap-vs-redis.html</a></p>
<p>这位哥异常牛掰,java低延迟方面的专家.把性能做到极致啊!!!<code>It was designed to be used in Java in a pause less, garbage free manner.</code>狂赞!!!先留着,有时间了看看源代码.</p>
<h2 id="高性能服务器架构"><a href="#高性能服务器架构" class="headerlink" title="高性能服务器架构"></a>高性能服务器架构</h2><p><a href="http://blog.csdn.net/zhoudaxia/article/details/14223755" target="_blank" rel="noopener">http://blog.csdn.net/zhoudaxia/article/details/14223755</a></p>
<p>这些经验可以参考下:</p>
<ul>
<li><p>数据拷贝</p>
<p>  特别是java,很多数据拷贝的代码埋得深,比如<code>StringBuilder</code>扩容,集合扩容等等.java中的数据拷贝除了带来cpu的压力,也会给gc带来压力.</p>
<p>  参考:<a href="/zero-copy/">使用零拷贝提高数据传输效率</a></p>
</li>
<li><p>上下文切换</p>
<p>  线程越多,上下文切换就会越多.需要合理评估处理模型和系统情况.按照SEDA的方式把一个请求划分为多个阶段,但是多个阶段的独立线程池真的会增加上下文的切换,但这样可能会让系统利用率最高.</p>
</li>
<li><p>内存分配</p>
<p>  采用类似于Buddy memory allocation的策略来减少开销.</p>
</li>
<li><p>锁竞争</p>
<p>  一定要控制好锁的粒度.某些场景用map来存放锁对象,而不要使用一把大锁.</p>
</li>
</ul>
<h2 id="数据库版本控制工具liquibase"><a href="#数据库版本控制工具liquibase" class="headerlink" title="数据库版本控制工具liquibase"></a>数据库版本控制工具liquibase</h2><p><a href="http://www.liquibase.org/quickstart.html" target="_blank" rel="noopener">http://www.liquibase.org/quickstart.html</a></p>
<p>今天和勇哥讨论了如何来控制数据库版本.我们想的方案是,数据库里面有张versions表,里面记录当前的版本是多少.然后数据库更新文件存在项目中,并以目录来区分.这样就可以在项目启动时,来对比是否有新版本,是否需要升级.这样可以做到全自动化,需要规范现在的开发同学的行为,更重要的一点是,没有人来做这个事情.</p>
<p>liquibase正好在做这个事情,他也支持sql格式的版本,学习成本相当低.而且有内置的数据库版本和集群场景的检测,给力,先试试.</p>
<p>参考:<a href="/database-version/">如何跟踪数据库结构变动</a></p>
<h2 id="可伸缩性最佳实践：来自eBay的经验"><a href="#可伸缩性最佳实践：来自eBay的经验" class="headerlink" title="可伸缩性最佳实践：来自eBay的经验"></a>可伸缩性最佳实践：来自eBay的经验</h2><p>(<a href="http://www.infoq.com/cn/articles/ebay-scalability-best-practices)[http://www.infoq.com/cn/articles/ebay-scalability-best-practices]" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/ebay-scalability-best-practices)[http://www.infoq.com/cn/articles/ebay-scalability-best-practices]</a></p>
<p>手里有本2011年的架构师特刊,翻开看到的第一篇文章.虽然有点老了,但是经验还是值得我们借鉴.</p>
<ul>
<li>按功能分割</li>
</ul>
<p>咱们现在的架构体系基本上遵循这条最佳实践.借助于dubbo/cxf实现功能服务化.应用层可以实现水平线性扩展.</p>
<ul>
<li>水平切分</li>
</ul>
<p>应用层面的无状态很重要,会话之类的东西可以放在缓存服务器上,尽量让LB来实现水平切分.</p>
<p>数据库层面读写分离/分区/分库/分表.</p>
<ul>
<li>避免分布式事务</li>
</ul>
<p>分布式第一定律,不要使用分布式.特别是两阶段提交,对系统的吞吐影响很大.ebay通过周密调整数据库操作的次序、异步恢复事件，以及数据核对（reconciliation）或者集中决算（settlement batches）来实现最终一致性.</p>
<ul>
<li>用异步策略解耦程序</li>
</ul>
<p>组件之间的异步带来的好处是解耦/缓冲压力.组件内的异步能提供跟灵活的资源管理策略(当然带来了上下文切换的开销).我们还需要异步任务管理/确保机制.</p>
<ul>
<li>将过程转变为异步的流</li>
<li>虚拟化所有层次</li>
</ul>
<p>虚拟化所有层次我们还做的不够好.硬件资源层面的虚拟化可以通过docker来实现.目前docker最缺少的是资源的管理/发现/注册能力.通用资源服务层面的虚拟化也可以通过注册中心来实现.结合配置管理系统/框架组件化,可以做到对应用的透明.</p>
<ul>
<li>适当地使用缓存</li>
</ul>
<p>缓存组件很多,分布式/集中式/进程内,不要选花了眼.同类型的我们只需要一种缓存组件,他必须要能支持丰富的数据结构,如果能提供持久话的能力最好(前提是在down掉的情况下要保证数据的一直.).</p>
<h2 id="Why-Choose-Jetty"><a href="#Why-Choose-Jetty" class="headerlink" title="Why Choose Jetty?"></a>Why Choose Jetty?</h2><p><a href="https://webtide.com/why-choose-jetty/" target="_blank" rel="noopener">https://webtide.com/why-choose-jetty/</a></p>
<p>一直有想法把jetty嵌入到我们的程序中来运行,jetty自身的体系结构优势便于我们去裁剪或者新增功能.</p>
<p>jetty的设计哲学很酷:</p>
<blockquote>
<p>Don’t put your application into Jetty, put Jetty into your application.</p>
</blockquote>
<h2 id="http-proxy"><a href="#http-proxy" class="headerlink" title="http proxy"></a>http proxy</h2><p><a href="http://rehorn.github.io/livepool/" target="_blank" rel="noopener">http://rehorn.github.io/livepool/</a></p>
<p><a href="http://mitmproxy.org/" target="_blank" rel="noopener">http://mitmproxy.org/</a></p>
<p>两个都是好东东.可以看下手机里面在干啥,吐槽下某些粗制滥造的app.也可以用来模拟http请求.</p>
<h2 id="jvm-flag"><a href="#jvm-flag" class="headerlink" title="jvm flag"></a>jvm flag</h2><p><a href="http://stas-blogspot.blogspot.jp/2011/07/most-complete-list-of-xx-options-for.html" target="_blank" rel="noopener">http://stas-blogspot.blogspot.jp/2011/07/most-complete-list-of-xx-options-for.html</a></p>
<p>最全的jvm flag.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/hibernate-no-session-in-dubbo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/hibernate-no-session-in-dubbo/" itemprop="url">hibernate应用报could not initialize proxy - no Session分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-17T21:52:17+08:00">
                2014-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-场景描述"><a href="#1-场景描述" class="headerlink" title="1.场景描述:"></a>1.场景描述:</h3><p>某项目使用hibernate,在切换到dubbo后,在构造结果对象时从延迟加载对象中获取数据时,报<code>org.hibernate.LazyInitializationException: could not initialize proxy - no Session</code></p>
<p>构造结果对象的操作没有在事务环境下执行.</p>
<h3 id="2-原因分析"><a href="#2-原因分析" class="headerlink" title="2.原因分析:"></a>2.原因分析:</h3><p>cxf不报错是因为在web.xml中配置了<code>org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter</code>,在请求到达web filter后,创建了<code>EntityManager</code>,请求结束后关闭<code>EntityManager</code>.在请求线程处理过程中,都可以拿到<code>EntityManager</code>,所以不会报错(至少可以从ThreadLocal中拿到).</p>
<p>切换为dubbo后,请求不会经过web filter,在事务模版代码中执行业务操作,可以正确的拿到<code>EntityManager</code>,不会报错.但是执行到构造结果对象时,就悲剧了.</p>
<h3 id="3-解决办法"><a href="#3-解决办法" class="headerlink" title="3.解决办法:"></a>3.解决办法:</h3><p>1.修改模版方法,把构造结果对象部分的代码也放到事务中执行.</p>
<p>2.编写支持dubbo的OpenEntityManagerInViewFilter</p>
<p>  可以通过<code>TransactionSynchronizationManager</code>做到如果<code>EntityManagerFactory</code>在线程变量中不存在则创建<code>EntityManager</code>,服务处理结束时,关闭<code>EntityManager</code>.</p>
<h3 id="4-优劣分析"><a href="#4-优劣分析" class="headerlink" title="4.优劣分析"></a>4.优劣分析</h3><ol>
<li><p>性能考虑</p>
<p> <code>open session in veiw</code>模式还是不怎么优雅,事务执行链路太长了,会影响性能.而且对于我们提供的服务接口来说,构造结果对象已经是最后一步了,后面再也不需要延迟加载对象,不需要在filter里面来做此操作.</p>
<p> web应用有在渲染模版时读取延迟加载对象的场景,这种场景使用还有意义.</p>
</li>
<li><p>功能角度</p>
<p> 如果遇到应用内的两个dubbo服务调用,dubbo会走injvm协议.此时请求不会经过io栈,但是会执行所有的dubbo filter.</p>
<p> 比如外部请求调用服务A,服务A调用内部服务B.</p>
<p> 外部请求调A时,filter创建<code>EntityManager</code>,然后调用服务B时,filter不创建<code>EntityManager</code>,但是在请求B结束时,filter关闭了<code>EntityManager</code>.在请求A中处理剩下的业务逻辑,如果遇到要操作数据库,就只有哭了.</p>
<p> 为什么web请求就不怕这种filter重入呢?web请求在forward时,你必须把request对象带进去,所以可以在request对象的attribute里面记录是否进过了这个filter.可以参考<code>org.springframework.web.filter.OncePerRequestFilter</code>.但是调用dubbo时,你只需要拿到服务代理对象就ok了,没有办法来知道整个请求链的情况.</p>
</li>
</ol>
<h3 id="5-最后结论"><a href="#5-最后结论" class="headerlink" title="5.最后结论"></a>5.最后结论</h3><p>还是修改下我们自己的代码,把构造结果对象部分的代码也放到事务中执行.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/vagrant/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/vagrant/" itemprop="url">使用vagrant</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-07T21:52:17+08:00">
                2014-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vagrant挺火的,用于快速搭建开发环境.官方网站一行大字<code>Development environments made easy.</code>很惹眼.他可以实现可分发的环境搭建.</p>
<p>我们现在要快速搭建开发测试环境的需求很强烈,我们希望使用TA来快速搭建我们的开发测试环境.so,begin…</p>
<h2 id="1-Centos上安装Virtaul-Box-1"><a href="#1-Centos上安装Virtaul-Box-1" class="headerlink" title="1.Centos上安装Virtaul Box[^1]"></a>1.<code>Centos</code>上安装<code>Virtaul Box</code>[^1]</h2><h3 id="1-1-安装问题unable-to-find-the-sources-of-your-current-Linux-kernel-Specify-KERN-DIR-lt-directory-gt-and-run-Make-again-2"><a href="#1-1-安装问题unable-to-find-the-sources-of-your-current-Linux-kernel-Specify-KERN-DIR-lt-directory-gt-and-run-Make-again-2" class="headerlink" title="1.1 安装问题unable to find the sources of your current Linux kernel. Specify KERN_DIR=&lt;directory&gt; and run Make again.[^2]"></a>1.1 安装问题<code>unable to find the sources of your current Linux kernel. Specify KERN_DIR=&lt;directory&gt; and run Make again.</code>[^2]</h3><p>Virtaul Box原因是<code>uname -r</code>和<code>ls /usr/src/kernels/</code>版本不一致,需要执行<code>yum update</code>,可以把国内的yum镜像用起来,会快点.完了重启下.</p>
<p>参考:</p>
<pre><code>http://rationallyparanoid.com/articles/virtualbox-centos-6.2.html
https://www.centos.org/forums/viewtopic.php?t=5603
</code></pre><h2 id="2-Centos上安装vagrant-3"><a href="#2-Centos上安装vagrant-3" class="headerlink" title="2.Centos上安装vagrant[^3]"></a>2.<code>Centos</code>上安装<code>vagrant</code>[^3]</h2><h3 id="2-1-static-IP-on-a-bridged-interface"><a href="#2-1-static-IP-on-a-bridged-interface" class="headerlink" title="2.1 static IP on a bridged interface"></a>2.1 <code>static IP on a bridged interface</code></h3><p>由于是公用的环境,会有很多个童鞋去访问,所以需要固定ip,并且上面的服务大家也可以自由访问,所以需要桥接网络.<br>但是官方网站上没有这样的配置,最后在github[^4]上发现了解决方案,测试了N遍,终于对头了:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;eth0&quot;, :ip =&gt; &quot;192.168.46.51&quot;
</code></pre><p>如果是mac上,就用:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;en0: Wi-Fi (AirPort)&quot;, :ip   =&gt; &quot;192.168.1.222&quot;
</code></pre><p>这样也需要注意下,如果要搭建多套环境,最好还是开一个新的网段,别和其他系统的ip冲突了.</p>
<p>如果只是你自己一个人玩,使用host-only吧,很简单.</p>
<h3 id="2-2-ext4-file-system-inconsistency系统稳定性问题"><a href="#2-2-ext4-file-system-inconsistency系统稳定性问题" class="headerlink" title="2.2 ext4 file system inconsistency系统稳定性问题"></a>2.2 <code>ext4 file system inconsistency</code>系统稳定性问题</h3><p>不知道什么原因,过段时间就启动不了,最后通过<code>ssh tunneling</code>打开<code>Virtaul Box</code>图形化界面才发现了这个<code>ext4 file system inconsistency</code>问题.</p>
<p>错误日志如下:</p>
<pre><code>There is a known Linux kernel bug which can lead to the corruption of the virtual disk image under these conditions.
Either enable the host I/O cache permanently in the VM settings or put the disk image and the snapshot folder onto a different file system.
The host I/O cache will now be enabled for this medium.
</code></pre><p>这是一个kernel的bug,centos forum上遇到这个问题[^5],其他的虚拟化vmware也有同样的问题.</p>
<p>如果<code>enable host I/O cache</code>,又会遇到各种问题[^6].比如<code>data loss</code>,<code>I/O errors</code>,<code>I/O requests time out</code>,<code>Physical memory waste</code>都是童鞋们不能接受的.</p>
<p>只有选择使用不同的文件系统,<code>fdisk -l</code>看下<code>/home</code>还比较大,有上T的空间.</p>
<pre><code>#卸载home分区
umount /dev/mapper/VolGroup-lv_home
#格式化
mkfs.ext3 /dev/mapper/VolGroup-lv_home
#装载home分区
mount /dev/mapper/VolGroup-lv_home /home
</code></pre><p>最后需要修改 <code>/etc/fstab</code>,改变挂载分区为<code>ext3</code>,重启后<code>sudo parted -l</code>看生效没有.现在可以在<code>/home</code>目录启动vagrant.</p>
<h3 id="2-3-guest分配多核反而更慢"><a href="#2-3-guest分配多核反而更慢" class="headerlink" title="2.3 guest分配多核反而更慢"></a>2.3 guest分配多核反而更慢</h3><p>如果开启多核(比如设置为20核),又遇到启动很慢的问题[^7].原因是:</p>
<blockquote>
<p>VMs with multiple vCPUs require that all allocated cores be free before processing can begin. This means, if you have a 2 vCPU machine,2 physical cores must be available, and a 4 vCPU requires 4 physical cores</p>
</blockquote>
<p>我开启20核,等了半个小时实在等不下去了.</p>
<p>查看cpu个数<code>grep &#39;physical id&#39; /proc/cpuinfo | sort -u</code>,2个物理cpu.查看每个cpu核心数,<code>grep &#39;core id&#39; /proc/cpuinfo | sort -u | wc -l</code>,每个cpu6个核心. 按照</p>
<blockquote>
<p>One point to note is that if you assign many more vCPUs than you have physical CPUs the system may run slower because the host spends more time scheduling threads than actually running them.</p>
</blockquote>
<p>,理论上12个应该是最优的,但是感觉还是不太靠谱,测试某app启动性能:</p>
<table>
<thead>
<tr>
<th>cpus</th>
<th>启动费时1</th>
<th>启动费时2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>34664</td>
<td>34291</td>
</tr>
<tr>
<td>2</td>
<td>29040</td>
<td>29104</td>
</tr>
<tr>
<td>4</td>
<td>26205</td>
<td>26495</td>
</tr>
<tr>
<td>6</td>
<td>27207</td>
<td>28566</td>
</tr>
<tr>
<td>8</td>
<td>48087</td>
<td>44483</td>
</tr>
</tbody>
</table>
<p>根据上面的测试,给vm配置4 cpus是最优的.卧槽,咱这服务两个物理cpu,每个cpu6 个核心,在加上<code>Hyperthreading</code>,<code>processor</code>都有24个了.如果这台服务器上有多个vm,咱这个测试最优的cpu数还会更少.</p>
<h2 id="3-制作package"><a href="#3-制作package" class="headerlink" title="3.制作package"></a>3.制作package</h2><h3 id="3-1-初始化vagrant环境"><a href="#3-1-初始化vagrant环境" class="headerlink" title="3.1 初始化vagrant环境"></a>3.1 初始化vagrant环境</h3><p>下载一个官方提供的base box[^8],用于初始化环境.这里我们选择CentOS 6.4 x86_64[^9].<br>在前面提到的ext3分区上进行:</p>
<pre><code>#添加镜像到 Vagrant
vagrant box add yiji package.box
#初始化环境
vagrant init yiji
</code></pre><p>当前目录会有一个<code>Vagrantfile</code>文件,加上前面测试的东东:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;eth0&quot;, :ip =&gt; &quot;192.168.46.51&quot;
config.vm.provider :virtualbox do |vb|
    vb.gui = false
    #设置内存
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, &quot;5120&quot;]
    #设置虚拟机ip
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, &quot;4&quot;]
    #设置ioapic,启用多个cpu时,必须设置.如果就一个cpu就不要设置,影响性能
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--ioapic&quot;, &quot;on&quot;]
    #vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpuexecutioncap&quot;, &quot;50&quot;]
end
</code></pre><p>启动虚拟机并ssh登陆:</p>
<pre><code>#启动虚拟机
vagrant up
#ssh登陆
vagrant ssh
</code></pre><h3 id="3-2-初始化VM环境"><a href="#3-2-初始化VM环境" class="headerlink" title="3.2 初始化VM环境"></a>3.2 初始化VM环境</h3><p>ssh登陆后,此时是用vagrant用户登陆的,这个时候神马事情都干不了,切换到root用户</p>
<pre><code>#修改root密码
sudo passwd root
#切换到root账户
su - root
</code></pre><p>配置路由和dns服务器:</p>
<pre><code>sudo route del default
sudo route add default gw 192.168.46.254
echo &quot;nameserver 192.168.45.10&quot; &gt; /etc/resolv.conf
echo &quot;nameserver 8.8.8.8&quot; &gt;&gt; /etc/resolv.conf
</code></pre><p>添加定时常用定时任务:</p>
<pre><code>#每12小时时间服务同步
0 */12 * * * rdate -s time.nist.gov
#每天清理日志
0 0 * * * /script/deletelog.sh
</code></pre><p>关闭防火墙:</p>
<pre><code>chkconfig ip6tables off
chkconfig iptables off
</code></pre><p>为了集中控制jvm的启动参数,定义java应用依赖环境变量:</p>
<pre><code>export APP_JAVA_OPTS=&quot;-Xms256m -Xmx512m&quot;
</code></pre><p>所有的java应用启动脚本中把<code>APP_JAVA_OPTS</code>加在启动参数的最后,它的优先级最高,就很方便的控制所有的jvm进程内存大小了.</p>
<p>上面有些东西可以脚本化的,尽量就脚本化,比如在<code>/etc/rc.d/rc.local</code>增加启动脚本<code>init.sh</code> .其他脚本分为 <code>init_network.sh</code> <code>init_env.sh</code> <code>init_common_app.sh</code> <code>init_app.sh</code></p>
<h3 id="3-3-安装memcache"><a href="#3-3-安装memcache" class="headerlink" title="3.3 安装memcache"></a>3.3 安装memcache</h3><p>安装:</p>
<pre><code>yum install memcached
</code></pre><p>配置文件:</p>
<pre><code>/etc/sysconfig/memcached
</code></pre><p>命令:</p>
<pre><code>service memcached start/stop/restart/status
</code></pre><p>设置开机启动:</p>
<pre><code>chkconfig memcached on
</code></pre><p>修改<code>/etc/init.d/memcached</code>可以修改memcache启动参数</p>
<h3 id="3-4-安装rabbitmq"><a href="#3-4-安装rabbitmq" class="headerlink" title="3.4 安装rabbitmq"></a>3.4 安装rabbitmq</h3><p>安装:</p>
<pre><code>yum install rabbitmq
 #安装webui
 rabbitmq-plugins enable rabbitmq_management
 #启用guest账户 访问web ui
 echo &quot;[{rabbit, [{loopback_users, []}]}].&quot; &gt;/etc/rabbitmq/rabbitmq.config
</code></pre><p>常用命令:</p>
<pre><code>service rabbitmq-server stop/start/etc.
</code></pre><p>web ui访问地址,账号密码guest/guest:</p>
<pre><code>http://192.168.46.51:15672/
</code></pre><p>设置开机启动:</p>
<pre><code>chkconfig rabbitmq-server on
</code></pre><h3 id="3-5-安装其他软件"><a href="#3-5-安装其他软件" class="headerlink" title="3.5 安装其他软件"></a>3.5 安装其他软件</h3><p>jdk/maven/memcache/zookeeper/rabbitmq/dubbo-monitor-simple/dubbo-admin</p>
<h3 id="3-6-服务列表说明"><a href="#3-6-服务列表说明" class="headerlink" title="3.6 服务列表说明"></a>3.6 服务列表说明</h3><table>
<thead>
<tr>
<th>服务</th>
<th>服务端口</th>
<th>web ui 端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>memcache</td>
<td>11211</td>
<td>无</td>
</tr>
<tr>
<td>zookeeper</td>
<td>2181</td>
<td>无</td>
</tr>
<tr>
<td>rabbitmq</td>
<td>5672</td>
<td>15672</td>
</tr>
<tr>
<td>dubbo-monitor</td>
<td>7070</td>
<td>7071</td>
</tr>
<tr>
<td>dubbo-admin</td>
<td>无</td>
<td>7073</td>
</tr>
</tbody>
</table>
<h3 id="3-7-制作分发包"><a href="#3-7-制作分发包" class="headerlink" title="3.7 制作分发包"></a>3.7 制作分发包</h3><pre><code>vagrant package
</code></pre><p>上面命令会在当前目录生成一个<code>package.box</code>文件,此文件拷贝到其他服务器,就可以快速搭建系统了.</p>
<h3 id="3-8-常用vagrant-命令"><a href="#3-8-常用vagrant-命令" class="headerlink" title="3.8 常用vagrant 命令"></a>3.8 常用vagrant 命令</h3><pre><code>#初始化环境,此命令会生成Vagrantfile配置文件,如果当前目录有Vagrantfile,不要执行此命令,直接up吧
vagrant init

#启动虚拟机  
vagrant up

#关闭虚拟机  
vagrant halt

# 重新启动虚拟机,如果Vagrantfile被修改后,执行此命令才能生效.
#但是修改cpu相关参数,此命令也不能重新加载配置,这个时候把虚拟机先停下来,
#通过ssh tunneling在gui界面里调整
vagrant reload 

#SSH至虚拟机
vagrant ssh

#查看虚拟机运行状态
vagrant status

# 销毁当前虚拟机
vagrant destroy  

#add box
vagrant box add boxname xxx.box

#remove box

vagrant box remove boxname

#list box
vagrant box list
</code></pre><h2 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4.写在最后"></a>4.写在最后</h2><p><code>virtual box</code>的性能让人担忧,如果部署应用太多需要仔细权衡下,如果只是搭建单机环境,使用vagrant还是很ok的.</p>
<p>[^1]: <a href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank" rel="noopener"><code>Virtual Box</code>下载地址</a><br>[^2]: <a href="https://www.centos.org/forums/viewtopic.php?t=5603" target="_blank" rel="noopener">unable to find the sources of your current Linux kernel</a><br>[^3]: <a href="http://www.vagrantup.com/downloads.htmlhttp://www.vagrantup.com/downloads.html" target="_blank" rel="noopener"><code>vagrant</code>下载地址</a><br>[^4]: <a href="https://github.com/mitchellh/vagrant/pull/1745" target="_blank" rel="noopener">Static ip addresses on public networks</a><br>[^5]: <a href="https://www.centos.org/forums/viewtopic.php?t=4436" target="_blank" rel="noopener">ext4 file system inconsistency</a><br>[^6]: <a href="https://www.virtualbox.org/manual/ch05.html#iocaching" target="_blank" rel="noopener">Host I/O caching</a><br>[^7]: <a href="http://www.reddit.com/r/linux/comments/1tqlsz/adding_cpus_to_virtualbox_guests_makes_guests/" target="_blank" rel="noopener">Adding CPUs to Virtualbox guests makes guests boot SLOWER</a><br>[^8]: <a href="http://www.vagrantbox.es/" target="_blank" rel="noopener">vagrant base box</a><br>[^9]: <a href="https://github.com/2creatives/vagrant-centos/releases/download/v6.4.2/centos64-x86_64-20140116.box" target="_blank" rel="noopener">vagrant base box CentOS 6.4 x86_64</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-06-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-06-reading-notes/" itemprop="url">2014年06月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-06-28T21:52:17+08:00">
                2014-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Awesome-Sysadmin"><a href="#Awesome-Sysadmin" class="headerlink" title="Awesome Sysadmin"></a>Awesome Sysadmin</h2><p><a href="https://github.com/kahun/awesome-sysadmin" target="_blank" rel="noopener">https://github.com/kahun/awesome-sysadmin</a></p>
<p>系统管理员的开源资源,资源暴多,技术选型时参考.</p>
<h2 id="Tengine"><a href="#Tengine" class="headerlink" title="Tengine"></a>Tengine</h2><p><a href="http://dmsimard.com/2014/06/21/a-use-case-of-tengine-a-drop-in-replacement-and-fork-of-nginx/" target="_blank" rel="noopener">http://dmsimard.com/2014/06/21/a-use-case-of-tengine-a-drop-in-replacement-and-fork-of-nginx/</a></p>
<p>使用tengine来做LB,通过Tengine的<code>unbuffered requests</code>特性实现了上传性能提升.</p>
<p>不过我自己装tengine启动就遇到了问题.</p>
<pre><code>the configuration file //Users/bohr/software/tengine/conf/nginx.conf syntax is ok
nginx: [emerg] mkdir() &quot;//Users/bohr/software/tengine/logs/access.log&quot; failed (21: Is a directory)
configuration file //Users/bohr/software/tengine/conf/nginx.conf test failed
</code></pre><h2 id="服务器操作系统应该选择-Debian-Ubuntu-还是-CentOS？"><a href="#服务器操作系统应该选择-Debian-Ubuntu-还是-CentOS？" class="headerlink" title="服务器操作系统应该选择 Debian/Ubuntu 还是 CentOS？"></a>服务器操作系统应该选择 Debian/Ubuntu 还是 CentOS？</h2><p><a href="http://www.zhihu.com/question/19599986" target="_blank" rel="noopener">http://www.zhihu.com/question/19599986</a></p>
<p>生产环境选择操作系统还是要慎重.现在我厂在线上用ubuntu,遇到过几次诡异事件(服务器无缘无故挂了,没有任何日志,时间跳变),看了这篇文章,SA应该会把线上的linux服务器统一了吧.</p>
<h2 id="web-starter-kit"><a href="#web-starter-kit" class="headerlink" title="web-starter-kit"></a>web-starter-kit</h2><p><a href="https://github.com/google/web-starter-kit" target="_blank" rel="noopener">https://github.com/google/web-starter-kit</a></p>
<p>Web Starter Kit is a starting point for multi-screen web development. It encompasses opinionated recommendations on boilerplate and tooling for building an experience that works great across multiple devices.</p>
<h2 id="微服务：分解应用以实现可部署性和可扩展性"><a href="#微服务：分解应用以实现可部署性和可扩展性" class="headerlink" title="微服务：分解应用以实现可部署性和可扩展性"></a>微服务：分解应用以实现可部署性和可扩展性</h2><p><a href="http://www.infoq.com/cn/articles/microservices-intro" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/microservices-intro</a><br><a href="http://microservices.io/index.html" target="_blank" rel="noopener">http://microservices.io/index.html</a></p>
<p>文章讨论了整体架构和微服务构架的优缺点.对于大型应用而言,微服务架构当然是首选.</p>
<p>API网关模式用于解耦应用客户端和微服务.我们可能没有考虑对不同的客户端提供不同粒度的服务(不同客户端的网络环境不一样).</p>
<p>对于非强一致性数据要求的场景,<code>事件驱动的异步更新</code>(服务发布事件声明有些数据发生了变化，其他的服务订阅这些事件并更新它们的数据)解耦了事件的生产者和消费者,简化了开发也提升了可用性.某应用,很多配置数据都存在memcache中,一笔业务需要查询缓存&gt;5次,每次都要去查,感觉很不爽.还是使用本地缓存+事件驱动的异步更新来做比较好.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="qiubo" />
            
              <p class="site-author-name" itemprop="name">qiubo</p>
              <p class="site-description motion-element" itemprop="description">Keep running!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">65</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/bohrqiu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:bohrqiu@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://qiuduo.me/" title="qiuduo" target="_blank">qiuduo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://thanhong.me/" title="daidai" target="_blank">daidai</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://dbalife.info" title="bingwei" target="_blank">bingwei</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2013 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiubo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
