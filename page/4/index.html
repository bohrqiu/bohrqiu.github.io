<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="秋波的程序生活" />










<meta name="description" content="Keep running!">
<meta property="og:type" content="website">
<meta property="og:title" content="qiubo&#39;s life">
<meta property="og:url" content="http://bohr.me/page/4/index.html">
<meta property="og:site_name" content="qiubo&#39;s life">
<meta property="og:description" content="Keep running!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="qiubo&#39;s life">
<meta name="twitter:description" content="Keep running!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://bohr.me/page/4/"/>





  <title>qiubo's life</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e81935b4d5ec7e3e782fe240cbd9c21c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">qiubo's life</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay Hungry, Stay Foolish</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/vagrant/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/vagrant/" itemprop="url">使用vagrant</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-07T21:52:17+08:00">
                2014-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vagrant挺火的,用于快速搭建开发环境.官方网站一行大字<code>Development environments made easy.</code>很惹眼.他可以实现可分发的环境搭建.</p>
<p>我们现在要快速搭建开发测试环境的需求很强烈,我们希望使用TA来快速搭建我们的开发测试环境.so,begin…</p>
<h2 id="1-Centos上安装Virtaul-Box-1"><a href="#1-Centos上安装Virtaul-Box-1" class="headerlink" title="1.Centos上安装Virtaul Box[^1]"></a>1.<code>Centos</code>上安装<code>Virtaul Box</code>[^1]</h2><h3 id="1-1-安装问题unable-to-find-the-sources-of-your-current-Linux-kernel-Specify-KERN-DIR-lt-directory-gt-and-run-Make-again-2"><a href="#1-1-安装问题unable-to-find-the-sources-of-your-current-Linux-kernel-Specify-KERN-DIR-lt-directory-gt-and-run-Make-again-2" class="headerlink" title="1.1 安装问题unable to find the sources of your current Linux kernel. Specify KERN_DIR=&lt;directory&gt; and run Make again.[^2]"></a>1.1 安装问题<code>unable to find the sources of your current Linux kernel. Specify KERN_DIR=&lt;directory&gt; and run Make again.</code>[^2]</h3><p>Virtaul Box原因是<code>uname -r</code>和<code>ls /usr/src/kernels/</code>版本不一致,需要执行<code>yum update</code>,可以把国内的yum镜像用起来,会快点.完了重启下.</p>
<p>参考:</p>
<pre><code>http://rationallyparanoid.com/articles/virtualbox-centos-6.2.html
https://www.centos.org/forums/viewtopic.php?t=5603
</code></pre><h2 id="2-Centos上安装vagrant-3"><a href="#2-Centos上安装vagrant-3" class="headerlink" title="2.Centos上安装vagrant[^3]"></a>2.<code>Centos</code>上安装<code>vagrant</code>[^3]</h2><h3 id="2-1-static-IP-on-a-bridged-interface"><a href="#2-1-static-IP-on-a-bridged-interface" class="headerlink" title="2.1 static IP on a bridged interface"></a>2.1 <code>static IP on a bridged interface</code></h3><p>由于是公用的环境,会有很多个童鞋去访问,所以需要固定ip,并且上面的服务大家也可以自由访问,所以需要桥接网络.<br>但是官方网站上没有这样的配置,最后在github[^4]上发现了解决方案,测试了N遍,终于对头了:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;eth0&quot;, :ip =&gt; &quot;192.168.46.51&quot;
</code></pre><p>如果是mac上,就用:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;en0: Wi-Fi (AirPort)&quot;, :ip   =&gt; &quot;192.168.1.222&quot;
</code></pre><p>这样也需要注意下,如果要搭建多套环境,最好还是开一个新的网段,别和其他系统的ip冲突了.</p>
<p>如果只是你自己一个人玩,使用host-only吧,很简单.</p>
<h3 id="2-2-ext4-file-system-inconsistency系统稳定性问题"><a href="#2-2-ext4-file-system-inconsistency系统稳定性问题" class="headerlink" title="2.2 ext4 file system inconsistency系统稳定性问题"></a>2.2 <code>ext4 file system inconsistency</code>系统稳定性问题</h3><p>不知道什么原因,过段时间就启动不了,最后通过<code>ssh tunneling</code>打开<code>Virtaul Box</code>图形化界面才发现了这个<code>ext4 file system inconsistency</code>问题.</p>
<p>错误日志如下:</p>
<pre><code>There is a known Linux kernel bug which can lead to the corruption of the virtual disk image under these conditions.
Either enable the host I/O cache permanently in the VM settings or put the disk image and the snapshot folder onto a different file system.
The host I/O cache will now be enabled for this medium.
</code></pre><p>这是一个kernel的bug,centos forum上遇到这个问题[^5],其他的虚拟化vmware也有同样的问题.</p>
<p>如果<code>enable host I/O cache</code>,又会遇到各种问题[^6].比如<code>data loss</code>,<code>I/O errors</code>,<code>I/O requests time out</code>,<code>Physical memory waste</code>都是童鞋们不能接受的.</p>
<p>只有选择使用不同的文件系统,<code>fdisk -l</code>看下<code>/home</code>还比较大,有上T的空间.</p>
<pre><code>#卸载home分区
umount /dev/mapper/VolGroup-lv_home
#格式化
mkfs.ext3 /dev/mapper/VolGroup-lv_home
#装载home分区
mount /dev/mapper/VolGroup-lv_home /home
</code></pre><p>最后需要修改 <code>/etc/fstab</code>,改变挂载分区为<code>ext3</code>,重启后<code>sudo parted -l</code>看生效没有.现在可以在<code>/home</code>目录启动vagrant.</p>
<h3 id="2-3-guest分配多核反而更慢"><a href="#2-3-guest分配多核反而更慢" class="headerlink" title="2.3 guest分配多核反而更慢"></a>2.3 guest分配多核反而更慢</h3><p>如果开启多核(比如设置为20核),又遇到启动很慢的问题[^7].原因是:</p>
<blockquote>
<p>VMs with multiple vCPUs require that all allocated cores be free before processing can begin. This means, if you have a 2 vCPU machine,2 physical cores must be available, and a 4 vCPU requires 4 physical cores</p>
</blockquote>
<p>我开启20核,等了半个小时实在等不下去了.</p>
<p>查看cpu个数<code>grep &#39;physical id&#39; /proc/cpuinfo | sort -u</code>,2个物理cpu.查看每个cpu核心数,<code>grep &#39;core id&#39; /proc/cpuinfo | sort -u | wc -l</code>,每个cpu6个核心. 按照</p>
<blockquote>
<p>One point to note is that if you assign many more vCPUs than you have physical CPUs the system may run slower because the host spends more time scheduling threads than actually running them.</p>
</blockquote>
<p>,理论上12个应该是最优的,但是感觉还是不太靠谱,测试某app启动性能:</p>
<table>
<thead>
<tr>
<th>cpus</th>
<th>启动费时1</th>
<th>启动费时2</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>34664</td>
<td>34291</td>
</tr>
<tr>
<td>2</td>
<td>29040</td>
<td>29104</td>
</tr>
<tr>
<td>4</td>
<td>26205</td>
<td>26495</td>
</tr>
<tr>
<td>6</td>
<td>27207</td>
<td>28566</td>
</tr>
<tr>
<td>8</td>
<td>48087</td>
<td>44483</td>
</tr>
</tbody>
</table>
<p>根据上面的测试,给vm配置4 cpus是最优的.卧槽,咱这服务两个物理cpu,每个cpu6 个核心,在加上<code>Hyperthreading</code>,<code>processor</code>都有24个了.如果这台服务器上有多个vm,咱这个测试最优的cpu数还会更少.</p>
<h2 id="3-制作package"><a href="#3-制作package" class="headerlink" title="3.制作package"></a>3.制作package</h2><h3 id="3-1-初始化vagrant环境"><a href="#3-1-初始化vagrant环境" class="headerlink" title="3.1 初始化vagrant环境"></a>3.1 初始化vagrant环境</h3><p>下载一个官方提供的base box[^8],用于初始化环境.这里我们选择CentOS 6.4 x86_64[^9].<br>在前面提到的ext3分区上进行:</p>
<pre><code>#添加镜像到 Vagrant
vagrant box add yiji package.box
#初始化环境
vagrant init yiji
</code></pre><p>当前目录会有一个<code>Vagrantfile</code>文件,加上前面测试的东东:</p>
<pre><code>config.vm.network &quot;public_network&quot;, :bridge =&gt; &quot;eth0&quot;, :ip =&gt; &quot;192.168.46.51&quot;
config.vm.provider :virtualbox do |vb|
    vb.gui = false
    #设置内存
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, &quot;5120&quot;]
    #设置虚拟机ip
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpus&quot;, &quot;4&quot;]
    #设置ioapic,启用多个cpu时,必须设置.如果就一个cpu就不要设置,影响性能
    vb.customize [&quot;modifyvm&quot;, :id, &quot;--ioapic&quot;, &quot;on&quot;]
    #vb.customize [&quot;modifyvm&quot;, :id, &quot;--cpuexecutioncap&quot;, &quot;50&quot;]
end
</code></pre><p>启动虚拟机并ssh登陆:</p>
<pre><code>#启动虚拟机
vagrant up
#ssh登陆
vagrant ssh
</code></pre><h3 id="3-2-初始化VM环境"><a href="#3-2-初始化VM环境" class="headerlink" title="3.2 初始化VM环境"></a>3.2 初始化VM环境</h3><p>ssh登陆后,此时是用vagrant用户登陆的,这个时候神马事情都干不了,切换到root用户</p>
<pre><code>#修改root密码
sudo passwd root
#切换到root账户
su - root
</code></pre><p>配置路由和dns服务器:</p>
<pre><code>sudo route del default
sudo route add default gw 192.168.46.254
echo &quot;nameserver 192.168.45.10&quot; &gt; /etc/resolv.conf
echo &quot;nameserver 8.8.8.8&quot; &gt;&gt; /etc/resolv.conf
</code></pre><p>添加定时常用定时任务:</p>
<pre><code>#每12小时时间服务同步
0 */12 * * * rdate -s time.nist.gov
#每天清理日志
0 0 * * * /script/deletelog.sh
</code></pre><p>关闭防火墙:</p>
<pre><code>chkconfig ip6tables off
chkconfig iptables off
</code></pre><p>为了集中控制jvm的启动参数,定义java应用依赖环境变量:</p>
<pre><code>export APP_JAVA_OPTS=&quot;-Xms256m -Xmx512m&quot;
</code></pre><p>所有的java应用启动脚本中把<code>APP_JAVA_OPTS</code>加在启动参数的最后,它的优先级最高,就很方便的控制所有的jvm进程内存大小了.</p>
<p>上面有些东西可以脚本化的,尽量就脚本化,比如在<code>/etc/rc.d/rc.local</code>增加启动脚本<code>init.sh</code> .其他脚本分为 <code>init_network.sh</code> <code>init_env.sh</code> <code>init_common_app.sh</code> <code>init_app.sh</code></p>
<h3 id="3-3-安装memcache"><a href="#3-3-安装memcache" class="headerlink" title="3.3 安装memcache"></a>3.3 安装memcache</h3><p>安装:</p>
<pre><code>yum install memcached
</code></pre><p>配置文件:</p>
<pre><code>/etc/sysconfig/memcached
</code></pre><p>命令:</p>
<pre><code>service memcached start/stop/restart/status
</code></pre><p>设置开机启动:</p>
<pre><code>chkconfig memcached on
</code></pre><p>修改<code>/etc/init.d/memcached</code>可以修改memcache启动参数</p>
<h3 id="3-4-安装rabbitmq"><a href="#3-4-安装rabbitmq" class="headerlink" title="3.4 安装rabbitmq"></a>3.4 安装rabbitmq</h3><p>安装:</p>
<pre><code>yum install rabbitmq
 #安装webui
 rabbitmq-plugins enable rabbitmq_management
 #启用guest账户 访问web ui
 echo &quot;[{rabbit, [{loopback_users, []}]}].&quot; &gt;/etc/rabbitmq/rabbitmq.config
</code></pre><p>常用命令:</p>
<pre><code>service rabbitmq-server stop/start/etc.
</code></pre><p>web ui访问地址,账号密码guest/guest:</p>
<pre><code>http://192.168.46.51:15672/
</code></pre><p>设置开机启动:</p>
<pre><code>chkconfig rabbitmq-server on
</code></pre><h3 id="3-5-安装其他软件"><a href="#3-5-安装其他软件" class="headerlink" title="3.5 安装其他软件"></a>3.5 安装其他软件</h3><p>jdk/maven/memcache/zookeeper/rabbitmq/dubbo-monitor-simple/dubbo-admin</p>
<h3 id="3-6-服务列表说明"><a href="#3-6-服务列表说明" class="headerlink" title="3.6 服务列表说明"></a>3.6 服务列表说明</h3><table>
<thead>
<tr>
<th>服务</th>
<th>服务端口</th>
<th>web ui 端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>memcache</td>
<td>11211</td>
<td>无</td>
</tr>
<tr>
<td>zookeeper</td>
<td>2181</td>
<td>无</td>
</tr>
<tr>
<td>rabbitmq</td>
<td>5672</td>
<td>15672</td>
</tr>
<tr>
<td>dubbo-monitor</td>
<td>7070</td>
<td>7071</td>
</tr>
<tr>
<td>dubbo-admin</td>
<td>无</td>
<td>7073</td>
</tr>
</tbody>
</table>
<h3 id="3-7-制作分发包"><a href="#3-7-制作分发包" class="headerlink" title="3.7 制作分发包"></a>3.7 制作分发包</h3><pre><code>vagrant package
</code></pre><p>上面命令会在当前目录生成一个<code>package.box</code>文件,此文件拷贝到其他服务器,就可以快速搭建系统了.</p>
<h3 id="3-8-常用vagrant-命令"><a href="#3-8-常用vagrant-命令" class="headerlink" title="3.8 常用vagrant 命令"></a>3.8 常用vagrant 命令</h3><pre><code>#初始化环境,此命令会生成Vagrantfile配置文件,如果当前目录有Vagrantfile,不要执行此命令,直接up吧
vagrant init

#启动虚拟机  
vagrant up

#关闭虚拟机  
vagrant halt

# 重新启动虚拟机,如果Vagrantfile被修改后,执行此命令才能生效.
#但是修改cpu相关参数,此命令也不能重新加载配置,这个时候把虚拟机先停下来,
#通过ssh tunneling在gui界面里调整
vagrant reload 

#SSH至虚拟机
vagrant ssh

#查看虚拟机运行状态
vagrant status

# 销毁当前虚拟机
vagrant destroy  

#add box
vagrant box add boxname xxx.box

#remove box

vagrant box remove boxname

#list box
vagrant box list
</code></pre><h2 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4.写在最后"></a>4.写在最后</h2><p><code>virtual box</code>的性能让人担忧,如果部署应用太多需要仔细权衡下,如果只是搭建单机环境,使用vagrant还是很ok的.</p>
<p>[^1]: <a href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank" rel="noopener"><code>Virtual Box</code>下载地址</a><br>[^2]: <a href="https://www.centos.org/forums/viewtopic.php?t=5603" target="_blank" rel="noopener">unable to find the sources of your current Linux kernel</a><br>[^3]: <a href="http://www.vagrantup.com/downloads.htmlhttp://www.vagrantup.com/downloads.html" target="_blank" rel="noopener"><code>vagrant</code>下载地址</a><br>[^4]: <a href="https://github.com/mitchellh/vagrant/pull/1745" target="_blank" rel="noopener">Static ip addresses on public networks</a><br>[^5]: <a href="https://www.centos.org/forums/viewtopic.php?t=4436" target="_blank" rel="noopener">ext4 file system inconsistency</a><br>[^6]: <a href="https://www.virtualbox.org/manual/ch05.html#iocaching" target="_blank" rel="noopener">Host I/O caching</a><br>[^7]: <a href="http://www.reddit.com/r/linux/comments/1tqlsz/adding_cpus_to_virtualbox_guests_makes_guests/" target="_blank" rel="noopener">Adding CPUs to Virtualbox guests makes guests boot SLOWER</a><br>[^8]: <a href="http://www.vagrantbox.es/" target="_blank" rel="noopener">vagrant base box</a><br>[^9]: <a href="https://github.com/2creatives/vagrant-centos/releases/download/v6.4.2/centos64-x86_64-20140116.box" target="_blank" rel="noopener">vagrant base box CentOS 6.4 x86_64</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-06-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-06-reading-notes/" itemprop="url">2014年06月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-06-28T21:52:17+08:00">
                2014-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Awesome-Sysadmin"><a href="#Awesome-Sysadmin" class="headerlink" title="Awesome Sysadmin"></a>Awesome Sysadmin</h2><p><a href="https://github.com/kahun/awesome-sysadmin" target="_blank" rel="noopener">https://github.com/kahun/awesome-sysadmin</a></p>
<p>系统管理员的开源资源,资源暴多,技术选型时参考.</p>
<h2 id="Tengine"><a href="#Tengine" class="headerlink" title="Tengine"></a>Tengine</h2><p><a href="http://dmsimard.com/2014/06/21/a-use-case-of-tengine-a-drop-in-replacement-and-fork-of-nginx/" target="_blank" rel="noopener">http://dmsimard.com/2014/06/21/a-use-case-of-tengine-a-drop-in-replacement-and-fork-of-nginx/</a></p>
<p>使用tengine来做LB,通过Tengine的<code>unbuffered requests</code>特性实现了上传性能提升.</p>
<p>不过我自己装tengine启动就遇到了问题.</p>
<pre><code>the configuration file //Users/bohr/software/tengine/conf/nginx.conf syntax is ok
nginx: [emerg] mkdir() &quot;//Users/bohr/software/tengine/logs/access.log&quot; failed (21: Is a directory)
configuration file //Users/bohr/software/tengine/conf/nginx.conf test failed
</code></pre><h2 id="服务器操作系统应该选择-Debian-Ubuntu-还是-CentOS？"><a href="#服务器操作系统应该选择-Debian-Ubuntu-还是-CentOS？" class="headerlink" title="服务器操作系统应该选择 Debian/Ubuntu 还是 CentOS？"></a>服务器操作系统应该选择 Debian/Ubuntu 还是 CentOS？</h2><p><a href="http://www.zhihu.com/question/19599986" target="_blank" rel="noopener">http://www.zhihu.com/question/19599986</a></p>
<p>生产环境选择操作系统还是要慎重.现在我厂在线上用ubuntu,遇到过几次诡异事件(服务器无缘无故挂了,没有任何日志,时间跳变),看了这篇文章,SA应该会把线上的linux服务器统一了吧.</p>
<h2 id="web-starter-kit"><a href="#web-starter-kit" class="headerlink" title="web-starter-kit"></a>web-starter-kit</h2><p><a href="https://github.com/google/web-starter-kit" target="_blank" rel="noopener">https://github.com/google/web-starter-kit</a></p>
<p>Web Starter Kit is a starting point for multi-screen web development. It encompasses opinionated recommendations on boilerplate and tooling for building an experience that works great across multiple devices.</p>
<h2 id="微服务：分解应用以实现可部署性和可扩展性"><a href="#微服务：分解应用以实现可部署性和可扩展性" class="headerlink" title="微服务：分解应用以实现可部署性和可扩展性"></a>微服务：分解应用以实现可部署性和可扩展性</h2><p><a href="http://www.infoq.com/cn/articles/microservices-intro" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/microservices-intro</a><br><a href="http://microservices.io/index.html" target="_blank" rel="noopener">http://microservices.io/index.html</a></p>
<p>文章讨论了整体架构和微服务构架的优缺点.对于大型应用而言,微服务架构当然是首选.</p>
<p>API网关模式用于解耦应用客户端和微服务.我们可能没有考虑对不同的客户端提供不同粒度的服务(不同客户端的网络环境不一样).</p>
<p>对于非强一致性数据要求的场景,<code>事件驱动的异步更新</code>(服务发布事件声明有些数据发生了变化，其他的服务订阅这些事件并更新它们的数据)解耦了事件的生产者和消费者,简化了开发也提升了可用性.某应用,很多配置数据都存在memcache中,一笔业务需要查询缓存&gt;5次,每次都要去查,感觉很不爽.还是使用本地缓存+事件驱动的异步更新来做比较好.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-05-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-05-reading-notes/" itemprop="url">2014年05月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-05-29T21:52:17+08:00">
                2014-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="面向GC的Java编程"><a href="#面向GC的Java编程" class="headerlink" title="面向GC的Java编程"></a>面向GC的Java编程</h2><p><a href="http://coolshell.cn/articles/11541.html" target="_blank" rel="noopener">http://coolshell.cn/articles/11541.html</a></p>
<p>好文,总结的很不错.</p>
<h2 id="spring-boot-Initializr"><a href="#spring-boot-Initializr" class="headerlink" title="spring boot Initializr"></a>spring boot Initializr</h2><p><a href="http://start.spring.io/" target="_blank" rel="noopener">http://start.spring.io/</a></p>
<p>有了这个,创建spring boot项目就快了.</p>
<h2 id="OOM-Killer"><a href="#OOM-Killer" class="headerlink" title="OOM Killer"></a>OOM Killer</h2><p>很早听说OOM Killer这个东东,感觉很神秘.而且以前分析某次线上故障,我得出的结论是OOM Killer,但是没有找到日志,囧!最近在玩vagrant,用的ubuntu box,虚拟机内存分配512m,某应用配置jvm内存<code>-Xms256M -Xmx512m -XX:PermSize=64m -XX:MaxPermSize=256m</code>.应用在启动过程中日志刷了一会儿就不动了,<code>command+c</code>结束后,console报出:</p>
<pre><code>INFO: Initializing Spring root WebApplicationContext
^C./tomcat.sh: line 6:  7649 Killed                  nohup mvn clean tomcat7:run -Dspring.profiles.active=$env -Dsys.name=$sysname &gt; &quot;$logfile&quot; 2&gt;&amp;1 &lt; /dev/null
</code></pre><p>找了很久,在<code>/var/log/syslog</code>发现如下日志:</p>
<pre><code>May 22 09:47:41 vagrant-ubuntu-saucy-64 kernel: [ 5499.448534] Out of memory: Kill process 7649 (java) score 788 or sacrifice child
May 22 09:47:41 vagrant-ubuntu-saucy-64 kernel: [ 5499.449012] Killed process 7649 (java) total-vm:1460964kB, anon-rss:407220kB, file-rss:0kB
</code></pre><p>这篇文章解释如何处理<a href="http://www.vpsee.com/2013/10/how-to-configure-the-linux-oom-killer/" target="_blank" rel="noopener">oom</a></p>
<h2 id="vagrant"><a href="#vagrant" class="headerlink" title="vagrant"></a>vagrant</h2><p><a href="https://github.com/astaxie/Go-in-Action/blob/master/ebook/zh/01.2.md" target="_blank" rel="noopener">https://github.com/astaxie/Go-in-Action/blob/master/ebook/zh/01.2.md</a></p>
<p><a href="http://blog.segmentfault.com/fenbox/1190000000264347" target="_blank" rel="noopener">http://blog.segmentfault.com/fenbox/1190000000264347</a></p>
<p><a href="http://docs.vagrantup.com/v2/getting-started/index.html" target="_blank" rel="noopener">http://docs.vagrantup.com/v2/getting-started/index.html</a></p>
<p>如果mac环境下虚拟机出现Failed to load VMMR0.r0 (VERR_SUPLIB_WORLD_WRITABLE),执行<code>sudo chmod o-w /Applications</code>再试试.</p>
<h2 id="构建高可用系统的常用招数"><a href="#构建高可用系统的常用招数" class="headerlink" title="构建高可用系统的常用招数"></a>构建高可用系统的常用招数</h2><p> <a href="http://bluedavy.me/?p=468" target="_blank" rel="noopener">http://bluedavy.me/?p=468</a></p>
<p>大牛的总结,分享+总结下:</p>
<ol>
<li><p>监控和报警</p>
<p>  监控和报警能提前发现问题/缩短故障时间,前提是得能正确的评估监控点.</p>
</li>
<li><p>SPoF(Single Point of Failure)</p>
<p>  单点故障也分层次的,不过我们coder一般只关注服务层面.服务尽量做到无状态,只需要做负载就ok了.不能做成无状态的就需要做集群了.实在不行的就做成主备.</p>
</li>
<li><p>解耦</p>
<p> 后端业务通过消息/事件来解耦(Eventbus也不错),前端页面模块化,互相不影响.</p>
</li>
<li><p>隔离</p>
<p> 隔离既要防止依赖的系统之间相互影响(防止故障传播),也要防止同一节点上的不同服务相互影响(资源隔离).</p>
<p> 宏观层面,区分服务重要性,如果都能服务化就好做了.不同服务可以选择配置不同个数的服务节点.重要的,访问量大的就多加点节点.这需要监控系统能准确评估服务访问情况.</p>
<p> 微观层面,在服务内部,服务对外提供的能力一般通过线程池大小和请求队列长度来控制.在这里,大不一定就好,多也不定就好.</p>
</li>
</ol>
<ol>
<li><p>容灾</p>
<p>  这里谈了几点:超时控制/非关键业务自动降级(用dubbo实现就很方便)/手动降级/自恢复能力(比如druid连接池)/自我保护能力</p>
</li>
</ol>
<p>自己补充点,快速故障恢复能力(日志很重要)/避免人为故障(减少开发人员犯错误的机会)/简单可依赖(能简单做的就绝对不玩花哨) </p>
<h2 id="Uses-MySQL-to-store-schema-less-data"><a href="#Uses-MySQL-to-store-schema-less-data" class="headerlink" title="Uses MySQL to store schema-less data"></a>Uses MySQL to store schema-less data</h2><p><a href="http://backchannel.org/blog/friendfeed-schemaless-mysql" target="_blank" rel="noopener">http://backchannel.org/blog/friendfeed-schemaless-mysql</a></p>
<p>如何用mysql来存储schema-less的数据,实现很简单.</p>
<p>数据表:</p>
<pre><code>CREATE TABLE entities (
    added_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    id BINARY(16) NOT NULL,
        updated TIMESTAMP NOT NULL,
    body MEDIUMBLOB,
    UNIQUE KEY (id),
    KEY (updated)
) ENGINE=InnoDB;
</code></pre><p>假如内容是:</p>
<pre><code>{
    &quot;id&quot;: &quot;71f0c4d2291844cca2df6f486e96e37c&quot;,
    &quot;user_id&quot;: &quot;f48b0440ca0c4f66991c4d5f6a078eaf&quot;,
    &quot;feed_id&quot;: &quot;f48b0440ca0c4f66991c4d5f6a078eaf&quot;,
    &quot;title&quot;: &quot;We just launched a new backend system for FriendFeed!&quot;,
    &quot;link&quot;: &quot;http://friendfeed.com/e/71f0c4d2-2918-44cc-a2df-6f486e96e37c&quot;,
    &quot;published&quot;: 1235697046,
    &quot;updated&quot;: 1235697046,
}
</code></pre><p>如果要给title建立索引,创建新表</p>
<pre><code>CREATE TABLE index_title (
    title varchar(100) ,
    entity_id BINARY(16) NOT NULL UNIQUE,
       PRIMARY KEY (user_id, entity_id)
) ENGINE=InnoDB;
</code></pre><p>查询的时候先从索引表查出entity_id,然后在去entities表查询详细数据.可以存储数据为text,方便数据库直接操作(必要性不是很大,text太占内存了),当然最好还是存储压缩后的二进制数据.不是经常改动的数据,应用层在加上一层cache.</p>
<p>索引可以异步建立,定时任务周期性的去找updated的新数据.</p>
<h2 id="为什么tomcat应用三分钟还关不掉"><a href="#为什么tomcat应用三分钟还关不掉" class="headerlink" title="为什么tomcat应用三分钟还关不掉"></a>为什么tomcat应用三分钟还关不掉</h2><p>这种问题一般是因为还有非deamon线程在容器关闭时没有正确的关闭导致的.可以在执行tomcat shutdown脚本后,jstack线程栈,看下还有哪些非deamon线程在执行.</p>
<p>应用使用线程持一定要记得关闭线程池,可以用spring提供的.</p>
<pre><code>&lt;bean id=&quot;taskExecutor&quot;
      class=&quot;org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor&quot;&gt;
    &lt;property name=&quot;corePoolSize&quot; value=&quot;10&quot;/&gt;
    &lt;property name=&quot;keepAliveSeconds&quot; value=&quot;200&quot;/&gt;
    &lt;property name=&quot;maxPoolSize&quot; value=&quot;50&quot;/&gt;
    &lt;property name=&quot;queueCapacity&quot; value=&quot;1000&quot;/&gt;
    &lt;property name=&quot;awaitTerminationSeconds&quot; value=&quot;60&quot;/&gt;
    &lt;property name=&quot;waitForTasksToCompleteOnShutdown&quot; value=&quot;true&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>注意最后面两个参数.</p>
<h2 id="The-New-RBAC-Resource-Based-Access-Control"><a href="#The-New-RBAC-Resource-Based-Access-Control" class="headerlink" title="The New RBAC: Resource-Based Access Control"></a>The New RBAC: Resource-Based Access Control</h2><p>最近看看shiro的相关资料,看到这篇文章.以前也隐隐约约思考过权限控制,也感觉<a href="http://en.wikipedia.org/wiki/Role-Based_Access_Control" target="_blank" rel="noopener">RBAC</a>控制粒度太粗了.作者提到<code>Explicit Access Control</code>概念,通过资源来解耦角色,控制粒度更细.从权限的分配角度来说,这样使用也更方便,可以把权限分配到某个用户/某个组/某个角色.</p>
<p>当然,我们把资源的权限和角色一一对于,角色有层次关系并且可以继承,RBAC也可以胜任细粒度的权限控制.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/maven-transitive-dependency-exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/maven-transitive-dependency-exception/" itemprop="url">maven 传递依赖检查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-05-28T21:52:17+08:00">
                2014-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="传递依赖检查"><a href="#传递依赖检查" class="headerlink" title="传递依赖检查"></a>传递依赖检查</h2><p>我们通过maven插件<code>org.apache.maven.plugins:maven-enforcer-plugin</code>启用<code>&lt;requireUpperBoundDeps/&gt;</code><br>来检查传递依赖是否高于直接依赖,如果传递依赖的版本比直接依赖的版本高,则打包失败.</p>
<p><code>&lt;requireUpperBoundDeps/&gt;</code>解释如下:</p>
<pre><code>IF:

    A--&gt;B1--&gt;C2

    A--&gt;C1

    C2&gt;C1

THEN:

    throw Exception;
</code></pre><p>我觉得这个检查很有必要,但是解析的范围太宽了.一个项目依赖了很多的开源组件,我们最好是限制这个检查只检查我们自己的jar包.</p>
<p>修改插件默认行为,在<code>org.apache.maven.plugins.enforcer.RequireUpperBoundDeps$RequireUpperBoundDepsVisitor#containsConflicts</code>中加入:</p>
<pre><code>String key=  resolvedPair.constructKey();
if(key!=null &amp;&amp; !key.startsWith(&quot;com.xxx&quot;)){//不检查groupId中包括非com.xxx开头的jar包
      return false;
}    
</code></pre><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p>下面说下检查出来的提示信息分析,比如下面的情况:</p>
<pre><code>Failed while enforcing RequireUpperBoundDeps. The error(s) are [
    Require upper bound dependencies error for xxx.interchange:interchange-facade-settle:1.0.0.20121009 paths to dependency are:
    +-xxx.ppm:ppm-integration:1.0.1.6
          +-xxx.interchange:interchange-facade-settle:1.0.0.20121009
    and
    +-xxx.ppm:ppm-integration:1.0.1.6
          +-xxx.core.payengine:payengine-facade:2.0.0.20140314
                +-xxx.interchange:interchange-facade-settle:1.0.0.20121009 (managed) &lt;-- xxx.interchange:interchange-facade-settle:1.3.0.20140303
</code></pre><p>第一个告诉我们<code>ppm-integration</code>–&gt;<code>interchange-facade-settle:1.0.0.20121009</code>.</p>
<p>第二个告诉我们<code>ppm-integration</code>–&gt;<code>payengine-facade:2.0.0.20140314</code>–&gt;<code>interchange-facade-settle:1.3.0.20140303</code></p>
<p>根据maven <code>最短路径优先原则</code>,<code>ppm-integration</code>最终会依赖<code>interchange-facade-settle:1.0.0.20121009</code>.但是<code>payengine-facade:2.0.0.20140314</code>它依赖<code>interchange-facade-settle:1.3.0.20140303</code>.如果classpath中只有<code>interchange-facade-settle:1.0.0.20121009</code>,运行时<code>payengine-facade</code>就有可能报找不到类,找不到方法之类的错误.</p>
<p>遇到这样的场景,最好是修改我们项目的直接依赖,让<code>ppm-integration</code>–&gt;<code>interchange-facade-settle:1.3.0.20140303</code>,然后测试下是否ok.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/cxf-unexpected-element/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/cxf-unexpected-element/" itemprop="url">烦人的cxf unexpected element 异常</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-05-15T21:52:17+08:00">
                2014-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h3><p>当cxf传输的数据对象结构变化时,比如请求对象减少了字段,响应对象增加了字段,在jaxb unmarsh时会抛出异常,导致接口访问失败.</p>
<pre><code>javax.xml.bind.UnmarshalException: unexpected element (uri:&quot;&quot;, local:&quot;name&quot;). Expected elements are &lt;{}name&gt;
</code></pre><p>上面这是一个典型的<code>unexpected element</code>异常,如果cxf客户端请求中多了一个<code>name</code>属性,或者cxf服务端响应中多了一个<code>name</code>属性,都会导致此异常.</p>
<h3 id="2-源代码分析"><a href="#2-源代码分析" class="headerlink" title="2.源代码分析"></a>2.源代码分析</h3><p>翻了下源代码:</p>
<p><code>com.sun.xml.bind.v2.runtime.unmarshaller.StructureLoader#childElement</code>检查是否是新增属性</p>
<pre><code> @Override
public void childElement(UnmarshallingContext.State state, TagName arg) throws SAXException {
    ChildLoader child = childUnmarshallers.get(arg.uri,arg.local);
    if(child==null) {//检查是否新增属性
        child = catchAll;
        if(child==null) {
            super.childElement(state,arg);
            return;
        }
    }

    state.loader = child.loader;
    state.receiver = child.receiver;
}
</code></pre><p>在<code>com.sun.xml.bind.v2.runtime.unmarshaller.Loader</code>中检查是否处理此问题</p>
<pre><code> public void childElement(UnmarshallingContext.State state, TagName ea) throws SAXException {
    // notify the error, then recover by ignoring the whole element.
    reportUnexpectedChildElement(ea, true);
    state.loader = Discarder.INSTANCE;
    state.receiver = null;
}

@SuppressWarnings({&quot;StringEquality&quot;})
protected final void reportUnexpectedChildElement(TagName ea, boolean canRecover) throws SAXException {
    if(canRecover &amp;&amp; !UnmarshallingContext.getInstance().parent.hasEventHandler())
    //这里默认会有个EventHandler,不会直接忽略此问题
        // this error happens particurly often (when input documents contain a lot of unexpected elements to be ignored),
        // so don&apos;t bother computing all the messages and etc if we know that
        // there&apos;s no event handler to receive the error in the end. See #286 
        return;
     //下面的代码抛出异常
    if(ea.uri!=ea.uri.intern() || ea.local!=ea.local.intern())
        reportError(Messages.UNINTERNED_STRINGS.format(), canRecover );
    else
        reportError(Messages.UNEXPECTED_ELEMENT.format(ea.uri,ea.local,computeExpectedElements()), canRecover );
}
</code></pre><p>在<code>org.apache.cxf.jaxb.io.DataReaderImpl#createUnmarshaller</code>中设置了<code>EventHandler</code>,注意这里的<code>veventHandler</code>,默认是没有的.</p>
<pre><code>if (setEventHandler) {
            um.setEventHandler(new WSUIDValidationHandler(veventHandler));
}
</code></pre><p> <code>org.apache.cxf.jaxb.io.DataReaderImpl.WSUIDValidationHandler</code>的代码很简单:</p>
<pre><code>private static class WSUIDValidationHandler implements ValidationEventHandler {
    ValidationEventHandler origHandler;
    WSUIDValidationHandler(ValidationEventHandler o) {
        origHandler = o;
    }

    public boolean handleEvent(ValidationEvent event) {
        String msg = event.getMessage();
        System.out.println(&quot;WSUIDValidationHandler&quot;+msg);
        if (msg != null
                &amp;&amp; msg.contains(&quot;:Id&quot;)
                &amp;&amp; (msg.startsWith(&quot;cvc-type.3.1.1: &quot;)
                || msg.startsWith(&quot;cvc-type.3.2.2: &quot;)
                || msg.startsWith(&quot;cvc-complex-type.3.1.1: &quot;)
                || msg.startsWith(&quot;cvc-complex-type.3.2.2: &quot;))) {
            return true;
        }
        if (origHandler != null) {
            return origHandler.handleEvent(event);
        }
        return false;
    }
}
</code></pre><p>先自己处理,自己处理不了的交给<code>origHandler</code>,那我们只需要自己构建一个<code>javax.xml.bind.ValidationEventHandler</code>来专门处理<code>unexpected element</code>异常,问题就得到了解决.</p>
<p><code>org.apache.cxf.jaxb.io.DataReaderImpl#setProperty</code>中有段代码:</p>
<pre><code>veventHandler = (ValidationEventHandler)m.getContextualProperty(&quot;jaxb-validation-event-handler&quot;);
       if (veventHandler == null) {
           veventHandler = databinding.getValidationEventHandler();
       }
</code></pre><p> 如果配置了<code>jaxb-validation-event-handler</code>属性,就可以让我们自己的<code>javax.xml.bind.ValidationEventHandler</code>来处理此异常.也可以设置<code>setEventHandler</code>为<code>false</code>,不设置异常处理器,忽略所有unmarsh异常,不过这样我感觉太暴力了点,这样做也忽略了<code>org.apache.cxf.jaxb.io.DataReaderImpl.WSUIDValidationHandler</code>的逻辑,点儿都不科学.</p>
<h3 id="3-实现"><a href="#3-实现" class="headerlink" title="3.实现"></a>3.实现</h3><p> 上面分析清楚了,实现就很简单,实现<code>javax.xml.bind.ValidationEventHandler</code></p>
<pre><code>public class IgnoreUnexpectedElementValidationEventHandler implements ValidationEventHandler {
        private static final Logger logger = LoggerFactory.getLogger(IgnoreUnexpectedElementValidationEventHandler.class);

        @Override
        public boolean handleEvent(ValidationEvent event) {
                String msg = event.getMessage();
                if (msg != null &amp;&amp; msg.startsWith(&quot;unexpected element&quot;)) {
                    logger.warn(&quot;{}&quot;, msg);
                    return true;
             }
              return false;
        }
}
</code></pre><p> 在<code>cxf:bus</code>中配置下就ok</p>
<pre><code>  &lt;cxf:bus&gt;
    &lt;cxf:properties&gt;
        &lt;entry key=&quot;jaxb-validation-event-handler&quot;&gt;
            &lt;bean class=&quot;IgnoreUnexpectedElementValidationEventHandler&quot;/&gt;
        &lt;/entry&gt;
    &lt;/cxf:properties&gt;
&lt;/cxf:bus&gt;
</code></pre><p> 建议只在线上环境启用此东东,线下还是不要开启,早点发现问题是好事.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/pojo-perperty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/pojo-perperty/" itemprop="url">java对象属性复制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-05-13T21:52:17+08:00">
                2014-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>java对象属性复制的工具类很多,常用的有<code>org.springframework.beans.BeanUtils#copyProperties</code>,<code>org.apache.commons.beanutils.BeanUtils#copyProperties</code>,这两个都是通过反射实现的,性能嘛,你关心TA就在那里,你不关心TA还是在那里.<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/pojo-perperty/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-04-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-04-reading-notes/" itemprop="url">2014年04月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-04-01T21:52:17+08:00">
                2014-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="oh-my-zsh"><a href="#oh-my-zsh" class="headerlink" title="oh-my-zsh"></a><a id="zsh">oh-my-zsh</a></h2><p><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Plugins-Overview" target="_blank" rel="noopener">https://github.com/robbyrussell/oh-my-zsh/wiki/Plugins-Overview</a></p>
<p><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Themes" target="_blank" rel="noopener">https://github.com/robbyrussell/oh-my-zsh/wiki/Themes</a></p>
<p>zsh才是王道啊,各种插件,很爽.</p>
<p>我用<code>colored-man colorize sublime mvn terminalapp</code>插件.theme用<code>avit</code>,再装上<a href="http://ethanschoonover.com/solarized" target="_blank" rel="noopener">Solarized Dark</a>,prefect!!!</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014-04-reading-notes/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-03-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-03-reading-notes/" itemprop="url">2014年03月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-03-07T21:52:17+08:00">
                2014-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Volatile-Vs-Static-in-JAVA"><a href="#Volatile-Vs-Static-in-JAVA" class="headerlink" title="Volatile Vs Static in JAVA"></a>Volatile Vs Static in JAVA</h2><p><a href="http://malalanayake.wordpress.com/2013/09/12/volatile-vs-static-in-java/" target="_blank" rel="noopener">http://malalanayake.wordpress.com/2013/09/12/volatile-vs-static-in-java/</a></p>
<p>volatile能保证原子性和可见性.对static field的内存模型认识不足导致有些概念模糊了.内存结构见图:</p>
<p><img src="/2014-03-reading-notes/volatilevsstaticinjava.png" alt=""></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014-03-reading-notes/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/2014-02-reading-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-02-reading-notes/" itemprop="url">2014年02月Reading Notes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-02-19T21:52:17+08:00">
                2014-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HTTP-1-1-Upgrade-header"><a href="#HTTP-1-1-Upgrade-header" class="headerlink" title="HTTP/1.1 Upgrade header"></a>HTTP/1.1 Upgrade header</h2><p><a href="http://en.wikipedia.org/wiki/HTTP/1.1_Upgrade_header" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/HTTP/1.1_Upgrade_header</a></p>
<p>通过http upgrade header来实现协议转换,比如把http协议转换为websocket协议.<a href="http://wildfly.org/news/2014/02/11/WildFly8-Final-Released/" target="_blank" rel="noopener">wildfly</a>走得更远,8080端口支持HTTP (Servlet, JAX-RS, JAX-WS), Web Sockets, HTTP Upgraded Remoting (EJB Invocation, Remote JNDI).<a href="http://jaitechwriteups.blogspot.com/2013/07/wildfly-800alpha3-released-with-support.html" target="_blank" rel="noopener">这篇文章</a>讲述了一些细节.</p>
<h2 id="When-should-I-not-kill-9-a-process"><a href="#When-should-I-not-kill-9-a-process" class="headerlink" title="When should I not kill -9 a process?"></a>When should I not kill -9 a process?</h2><p><a href="http://unix.stackexchange.com/questions/8916/when-should-i-not-kill-9-a-process" target="_blank" rel="noopener">http://unix.stackexchange.com/questions/8916/when-should-i-not-kill-9-a-process</a></p>
<p>Generally, you should use kill -15 before kill -9 to give the target process a chance to clean up after itself. </p>
<h2 id="Java里快如闪电的线程间通讯"><a href="#Java里快如闪电的线程间通讯" class="headerlink" title="Java里快如闪电的线程间通讯"></a>Java里快如闪电的线程间通讯</h2><p><a href="http://www.infoq.com/cn/articles/High-Performance-Java-Inter-Thread-Communications" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/High-Performance-Java-Inter-Thread-Communications</a></p>
<p>多线程中,锁是一个很大的性能开销.如果采用无锁实现,会发现原来世界可以更美好.</p>
<h2 id="elasticsearch中文学习文档"><a href="#elasticsearch中文学习文档" class="headerlink" title="elasticsearch中文学习文档"></a>elasticsearch中文学习文档</h2><p><a href="https://github.com/medcl/elasticsearch-rtf" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-rtf</a></p>
<p><a href="http://tanjianna.diandian.com/post/2013-07-27/elasticsearch-study" target="_blank" rel="noopener">http://tanjianna.diandian.com/post/2013-07-27/elasticsearch-study</a></p>
<p>elasticsearch中文发行版，针对中文集成了相关插件，并带有Demo，方便新手学习,或者在生产环境中直接使用</p>
<h2 id="elasticsearch中文学习文档-1"><a href="#elasticsearch中文学习文档-1" class="headerlink" title="elasticsearch中文学习文档"></a>elasticsearch中文学习文档</h2><p><a href="http://webappchecklist.com/" target="_blank" rel="noopener">http://webappchecklist.com/</a><br>Web开发者必备：Web应用检查清单</p>
<h2 id="Cache-coherence"><a href="#Cache-coherence" class="headerlink" title="Cache coherence"></a>Cache coherence</h2><p><a href="http://en.wikipedia.org/wiki/Cache_coherence" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Cache_coherence</a></p>
<p>In a shared memory multiprocessor system with a separate cache memory for each processor, it is possible to have many copies of any one instruction operand: one copy in the main memory and one in each cache memory. When one copy of an operand is changed, the other copies of the operand must be changed also.</p>
<p><strong>Cache coherence</strong> is the discipline that ensures that changes in the values of shared operands are propagated throughout the system in a timely fashion.</p>
<h2 id="高性能、高流量Java-Web站点打造的22条建议"><a href="#高性能、高流量Java-Web站点打造的22条建议" class="headerlink" title="高性能、高流量Java Web站点打造的22条建议"></a>高性能、高流量Java Web站点打造的22条建议</h2><p><a href="http://www.csdn.net/article/2013-12-20/2817861-22-recommendations-for-building-effective-high-traffic-web-application" target="_blank" rel="noopener">http://www.csdn.net/article/2013-12-20/2817861-22-recommendations-for-building-effective-high-traffic-web-application</a></p>
<ul>
<li><p>通过使用类似Lucene的索引器做表的索引，使用一个允许在结果集上做基于其他字段的查询.</p>
<p>  对于复杂的查询,在数据库中直接做是很影响性能的,通过使用搜索引擎,能减轻数据库的压力.</p>
</li>
<li><p>考虑使用Oracle或者MySQL分片</p>
<p>  数据量大时,做分片能获得不错的性能提升.</p>
</li>
<li><p>不要使用session stickiness</p>
<p>  会话粘滞会带来一系列的问题.我们的分布式session方案中,默认要求LB启用会话粘滞,这样做的目的是能让本地缓存生效.当需要failover时,才去后端memcached中取数据.能同时兼顾性能和高可用.</p>
</li>
<li><p>终止反向代理商的SSL</p>
<p>  在反向代理或者LB上卸载ssl,能够减轻web应用服务器的压力.</p>
</li>
<li><p>拥抱一切“reactor”</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://bohr.me/serialization-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qiubo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qiubo's life">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/serialization-framework/" itemprop="url">序列化框架选型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-01-26T21:52:17+08:00">
                2014-01-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="序列化框架选型"><a href="#序列化框架选型" class="headerlink" title="序列化框架选型"></a>序列化框架选型</h3><p>分布式应用中,序列化很关键,选择一个合适的序列化框架能给分布式应用带来性能红利,还能减少不必要的麻烦.本文仅仅从我遇到的一些实际问题来说明序列化的选型.更深入部分也可以参考<a href="http://bohr.me/2012/04/02/java-serialization.html">java序列化</a></p>
<p>序列化框架的性能可以参考<a href="https://github.com/eishay/jvm-serializers/wiki" target="_blank" rel="noopener">jvm-serializers</a>,<code>Kryo</code>的性能还是很牛叉的.</p>
<p>除了性能,还要考虑兼容性/序列化后的大小.如果仅仅考虑性能,我们选择<code>Kryo</code>就足够了.但是Kryo有些用着不爽的地方,比如不是线程安全的/兼容性.</p>
<h4 id="1-兼容性"><a href="#1-兼容性" class="headerlink" title="1.兼容性"></a>1.兼容性</h4><p>字段增删不兼容,这个问题有时候很麻烦.比如用memache做缓存,把对象序列化后存入memcache,如果出现字段增删的情况,必须在服务重启的时候把缓存清空,不然就会导致<a href="http://bohr.me/2013/11/03/kryo-oom.html">灰常严重的BUG</a>.但是如果应用服务器有多台,这个问题还是避免不了.总会有个时间窗口会出现不同服务器上的同一个应用有不同的类版本,仍然可能会出现灰常严重的BUG.</p>
<p>现在的<code>Kryo</code>提供了兼容性的支持,使用<code>CompatibleFieldSerializer.class</code>,在<code>kryo.writeClassAndObject</code>写入的信息如下:</p>
<pre><code>class name|field lenght|field1 name|field2 name|field1 value| filed2 value
</code></pre><p>读入<code>kryo.readClassAndObject</code>时,会先读入<code>field names</code>.然后匹配当前反序列化类的field和顺序,构造结果.</p>
<p>子类和父类中有同名的字段时，kryo反序列化会丢失字段值,出现问题的原因和<a href="http://bohr.me/2013/11/29/hessian-java-serialization.html">hessian</a>出问题一样.</p>
<p>给kryo提交了一个<a href="https://github.com/EsotericSoftware/kryo/pull/187" target="_blank" rel="noopener">improvement</a>,在初始化类型信息时,去掉父类中重复名称的field.</p>
<h4 id="2-线程安全"><a href="#2-线程安全" class="headerlink" title="2.线程安全"></a>2.线程安全</h4><p>非线程安全也很好处理,每次都new对象出来,当然这样不是最佳的使用方式.通过线程变量来解决会比较合理,保证了性能还能提供很方便使用的工具类.</p>
<h4 id="3-如何生成对象"><a href="#3-如何生成对象" class="headerlink" title="3.如何生成对象"></a>3.如何生成对象</h4><p>对于没有无参构造器的类来说，生成新对象是个问题，可以使用java内部的机制来new一个对象。<br>可以参考下<a href="https://github.com/magro/kryo-serializers/blob/master/src/main/java/de/javakaffee/kryoserializers/KryoReflectionFactorySupport.java" target="_blank" rel="noopener">KryoReflectionFactorySupport</a>的实现方式</p>
<h4 id="4-性能"><a href="#4-性能" class="headerlink" title="4.性能"></a>4.性能</h4><p>下面测试了java下的各种序列化实现方式的性能</p>
<pre><code>0 Serialisation    write=4,206ns read=16,945ns total=21,151ns
 1 Serialisation    write=3,626ns read=18,205ns total=21,831ns
0 MemoryByteBuffer write=270ns read=324ns total=594ns
 1 MemoryByteBuffer write=270ns read=330ns total=600ns
 0 MemoryByteBufferWithNativeOrder  write=357ns read=360ns total=717ns
 1 MemoryByteBufferWithNativeOrder  write=323ns read=359ns total=682ns
 0 DirectByteBuffer write=236ns read=325ns total=561ns
 1 DirectByteBuffer write=231ns read=301ns total=532ns
 0 DirectByteBufferWithNativeOrder  write=261ns read=310ns total=571ns
 1 DirectByteBufferWithNativeOrder  write=243ns read=290ns total=533ns
 0 UnsafeMemory write=28ns read=82ns total=110ns
 1 UnsafeMemory write=24ns read=75ns total=99ns
 0 kryo write=373ns read=348ns total=721ns
 1 kryo write=390ns read=386ns total=776ns
 0 kryoWithCompatibleFields write=1,037ns read=1,625ns total=2,662ns
 1 kryoWithCompatibleFields write=1,038ns read=1,657ns total=2,695ns
 0 kryoWithCompatibleFieldsAndDuplicateFieldAccept  write=1,077ns read=1,560ns total=2,637ns
 1 kryoWithCompatibleFieldsAndDuplicateFieldAccept  write=1,064ns read=1,583ns total=2,647ns
 0 kryoWithUnsafe   write=164ns read=204ns total=368ns
 1 kryoWithUnsafe   write=168ns read=210ns total=378ns
 0 fastjson write=1,942ns read=5,834ns total=7,776ns
 1 fastjson write=1,873ns read=5,879ns total=7,752ns
</code></pre><p>每种序列化执行1000000次,并且有预热. 各组数据相对比较,可以得出一些结论:</p>
<ul>
<li>直接调用unsafe,最快,但是最麻烦</li>
<li>java自带的序列化很慢,最好不要用</li>
<li>kryo2.22提供的unsafe支持,性能非常卓越</li>
<li>kryo兼容性序列化器,开销挺大.写需要写入字段名,读的时候还需要做匹配撮合,读比写慢</li>
<li>fastjson也挺快的,兼容性\跨语言互操性俱佳.</li>
</ul>
<p>序列化后的字节大小可以参考<a href="https://github.com/eishay/jvm-serializers/wiki" target="_blank" rel="noopener">jvm-serializers</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="qiubo" />
            
              <p class="site-author-name" itemprop="name">qiubo</p>
              <p class="site-description motion-element" itemprop="description">Keep running!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/bohrqiu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:qiuboboy@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://qiuduo.me/" title="qiuduo" target="_blank">qiuduo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://thanhong.me/" title="daidai" target="_blank">daidai</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2013 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiubo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
